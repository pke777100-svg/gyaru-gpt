<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>waru GPT</title>
<style>
:root{
 --bg:#f7f7f8; --chat:#fff; --user:#dcf8c6; --top:#eee
}
.line { --bg:#e5ddd5; --chat:#fff; --user:#dcf8c6; --top:#075e54 }
body { margin:0; font-family:-apple-system; background:var(--bg); height:100vh; overflow:hidden }
header { position:fixed; top:0; left:0; right:0; height:50px; background:var(--top); display:flex; align-items:center; padding:0 10px; z-index:100; }
header button{margin-left:10px}
.chat-container { display:flex; flex-direction:column; padding-top:50px; height:calc(100% - 50px); }
.chat{flex:1; overflow:auto; padding:10px}
.msg{margin:4px 0; max-width:70%; padding:8px; border-radius:10px; word-break:break-word}
.msg.user{align-self:flex-end; background:var(--user)}
.msg.ai{align-self:flex-start; background:var(--chat); border:1px solid #ddd}
input, button, textarea{font-size:16px}
.controls{display:flex; padding:5px; gap:5px; border-top:1px solid #ccc}
textarea{flex:1; resize:none}
.blink{animation:blink 1s step-start 0s infinite}
@keyframes blink{50%{opacity:0}}
.thread-list{position:fixed; top:50px; left:0; width:200px; height:100%; overflow:auto; background:#222; color:#fff; display:none; flex-direction:column}
.thread-list button{width:100%; text-align:left; padding:8px; border:none; background:none; color:#fff}
.thread-list button.active{background:#444}
</style>
</head>
<body>
<header>
 <b>waru GPT</b>
 <button onclick="toggleThreadList()">☰</button>
 <button onclick="switchUI()">LINE/GPT切替</button>
 <button onclick="togglePersona()">人格</button>
</header>

<div class="thread-list" id="threads"></div>

<div class="chat-container">
 <div class="chat" id="chat"></div>
 <div class="controls">
   <textarea id="q" rows="2" placeholder="Enterで送信"></textarea>
   <button onclick="send()">送信</button>
 </div>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById("chat");
const q=document.getElementById("q");
let persona="joker";
let uiMode="gpt";
let threads=[], curThread=null;

function toggleThreadList(){
 document.getElementById("threads").style.display=document.getElementById("threads").style.display==="flex"?"none":"flex";
 renderThreads();
}

function switchUI(){
 uiMode = uiMode==="gpt"?"line":"gpt";
 document.body.className = uiMode==="line"?"line":"";
}

function togglePersona(){
 if(persona==="joker") persona="harley";
 else if(persona==="harley") persona="ai";
 else persona="joker";
 alert("現在の人格: "+persona);
}

function newThread(title){
 const id="t"+Date.now();
 threads.unshift({id,title:title||"New Chat", messages:[]});
 curThread=id;
 renderThreads(); renderChat();
}

function renderThreads(){
 const div=document.getElementById("threads");
 div.innerHTML="";
 threads.forEach(t=>{
  const b=document.createElement("button");
  b.textContent=t.title;
  b.className=t.id===curThread?"active":"";
  b.onclick=()=>{curThread=t.id; renderChat();}
  div.appendChild(b);
 });
}

function renderChat(){
 chat.innerHTML="";
 const t=threads.find(x=>x.id===curThread);
 if(!t) return;
 t.messages.forEach(m=>{
  const d=document.createElement("div");
  d.className="msg "+m.role;
  d.textContent=m.content;
  chat.appendChild(d);
 });
 chat.scrollTop=1e9;
}

q.addEventListener("keydown",e=>{
 if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); send(); }
});

async function send(){
 const text=q.value.trim(); if(!text) return;
 q.value="";
 const t=threads.find(x=>x.id===curThread);
 t.messages.push({role:"user", content:text});
 const aiDiv={role:"ai",content:"入力中…"}; t.messages.push(aiDiv);
 renderChat();
 chat.lastChild.classList.add("blink");

 try{
  const res=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({messages:[{role:"user", content:text}], persona})
  });
  const data=await res.json();
  chat.lastChild.classList.remove("blink");
  aiDiv.content=data.choices?.[0]?.message?.content||"エラー";
  renderChat();
 }catch(e){
  chat.lastChild.classList.remove("blink");
  aiDiv.content="エラー: "+e.message;
  renderChat();
 }
}

// 初期
if(!threads.length) newThread();
</script>
</body>
</html>
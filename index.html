<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
 --bg:#f7f7f8; --side:#202123; --chat:#fff; --user:#dcf8c6; --accent:#007aff
}
.dark{
 --bg:#1c1c1e; --chat:#2c2c2e; --user:#2f7d4f; --accent:#0a84ff
}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden}
.app{display:flex;height:100%}

/* sidebar */
.side{
 position:fixed;top:0;left:0;height:100%;width:260px;background:var(--side);color:#fff;z-index:20;
 transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column
}
.side.open{transform:translateX(0)}
.side h1{font-size:16px;margin:10px}
.side input,.side button{margin:6px;border-radius:6px;border:0;padding:8px}
.list{flex:1;overflow:auto}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer}
.item.active{background:#2a2b32}
.item span.title{flex:1}
.more{padding:4px 8px;font-size:20px;color:#aaa}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10}
.overlay.show{display:block}

/* main */
.main{flex:1;display:flex;flex-direction:column}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;align-items:center}
.chat{flex:1;overflow:auto;padding:12px}
.msg{display:flex;margin:8px 0;align-items:flex-end}
.msg.user{justify-content:flex-end}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap}
.msg.user .bubble{background:var(--user)}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;display:flex;flex-direction:column;gap:6px}
textarea{width:100%;font-size:16px;resize:none}
img.gen{max-width:70%;border-radius:10px}

/* menu */
.menuBox{
 position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:12px 12px 0 0;display:none;z-index:30;padding:10px
}
.menuBox button{width:100%;padding:12px;margin:6px 0;font-size:16px}

/* å…¥åŠ›ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.blinking{animation:blinker 1s linear infinite;color:var(--accent)}
@keyframes blinker{50%{opacity:0}}
</style>
</head>
<body>

<div class="overlay" id="ov" onclick="toggleSide(false);closeMenu()"></div>

<!-- sidebar -->
<div class="side" id="side">
 <h1>waru GPT</h1>
 <input placeholder="æ¤œç´¢" oninput="render(this.value)">
 <button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
 <button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
 <button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
 <div class="list" id="threads"></div>
</div>

<!-- main -->
<div class="app">
 <div class="main">
  <div class="top">
   <span onclick="toggleSide()">â˜°</span><b>waru GPT</b>
   <span style="margin-left:auto;cursor:pointer;" onclick="toggleMenu(true)">âš™ï¸</span>
  </div>
  <div class="chat" id="chat"></div>
  <div class="controls">
   <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
   <button onclick="send()">é€ä¿¡</button>
  </div>
 </div>
</div>

<!-- âš™ï¸è¨­å®š -->
<div class="menuBox" id="menu">
 <label>æ¯’èˆŒåº¦: <input type="range" id="toxic" min="0" max="100" value="50"></label>
 <label>ç‹‚æ°—åº¦: <input type="range" id="mad" min="0" max="100" value="50"></label>
 <label><input type="checkbox" id="dualReply"> ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼&ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³åŒæ™‚è¿”ç­”</label>
 <label><input type="checkbox" id="lineUI"> LINEé¢¨UI</label>
 <label><input type="checkbox" id="speech"> éŸ³å£°èª­ã¿ä¸Šã’</label>
 <button onclick="renameThread()">âœï¸åå‰å¤‰æ›´</button>
 <button onclick="deleteThread()">ğŸ—‘å‰Šé™¤</button>
 <button onclick="toggleMenu(false)">âŒé–‰ã˜ã‚‹</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const side=document.getElementById("side");
const ov=document.getElementById("ov");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const menu=document.getElementById("menu");
let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR");
let menuId=null;

function toggleSide(v){
 const o=v!==undefined?v:!side.classList.contains("open");
 side.classList.toggle("open",o);
 ov.classList.toggle("show",o);
}
function toggleMenu(v){menu.style.display=v?"block":"none";ov.classList.toggle("show",v)}
function save(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR",cur)}
function newThread(p){const id="t"+Date.now();threads.unshift({id,title:"New chat",p,his:[],toxic:50,mad:50});cur=id;save();render();toggleSide(false)}
function openMenu(e,id){e.stopPropagation();menuId=id;toggleMenu(true)}
function closeMenu(){toggleMenu(false);menuId=null}
function renameThread(){const t=threads.find(x=>x.id===menuId);if(!t)return;const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title);if(n){t.title=n;save();render();} closeMenu();}
function deleteThread(){threads=threads.filter(x=>x.id!==menuId);if(cur===menuId)cur=threads[0]?.id||null;save();render();closeMenu();}

function render(f=""){
 threadsDiv.innerHTML="";
 threads.filter(t=>t.title.includes(f)).forEach(t=>{
  const d=document.createElement("div");
  d.className="item"+(t.id===cur?" active":"");
  d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
  d.onclick=()=>{cur=t.id;save();render();toggleSide(false)};
  d.querySelector(".more").onclick=e=>openMenu(e,t.id);
  threadsDiv.appendChild(d);
 });
 chat.innerHTML="";
 const t=threads.find(x=>x.id===cur); if(!t)return;
 t.his.forEach(m=>{
  if(m.type==="img")chat.innerHTML+=`<div class="msg ai"><img class="gen" src="${m.url}"></div>`;
  else chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}</div></div>`;
 });
 chat.scrollTop=1e9;
}

function persona(p){if(p==="joker")return"ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼";if(p==="harley")return"ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³";return"ğŸ¤–ç„¡æ©Ÿè³ªAI"}

q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send()}};

async function send(){
 const t=threads.find(x=>x.id===cur); if(!t)return;
 const text=q.value.trim(); if(!text)return;q.value="";
 const toxicV=t.toxic;const madV=t.mad;
 t.his.push({role:"user",content:text});
 const blinkDiv=document.createElement("div");blinkDiv.className="msg ai";blinkDiv.innerHTML=`<div class="bubble blinking">å…¥åŠ›ä¸­â€¦</div>`;
 chat.appendChild(blinkDiv);chat.scrollTop=1e9;

 const messages=[{role:"system",content:`å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã®è„³å†…ğŸ§ ä¸–ç•Œã€‚\n\n${persona(t.p)}äººæ ¼å›ºå®šã€‚æ¯’èˆŒã¨æ¯”å–©ã®ã¿ã€‚å¿…ãšã€Œãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§ã€ã‚’å«ã‚ã‚‹ã€‚\næ¯’èˆŒåº¦:${toxicV}/100 ç‹‚æ°—åº¦:${madV}/100`}];
 messages.push({role:"user",content:text});

 try{
  const res=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages,persona:t.p})});
  const data=await res.json();
  chat.removeChild(blinkDiv);
  const ans=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
  t.his.push({role:"assistant",content:ans});
  if(document.getElementById("speech").checked){const u=new SpeechSynthesisUtterance(ans);speechSynthesis.speak(u);}
  if(t.title==="New chat") t.title=ans.replace(/\n/g," ").slice(0,18);
  save();render();
 }catch(e){chat.removeChild(blinkDiv);t.his.push({role:"assistant",content:"ã‚¨ãƒ©ãƒ¼"});render();}
}

if(!threads.length)newThread("joker");else render();
</script>

</body>
</html>
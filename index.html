<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root {
  --bg:#f7f7f8; --side:#202123; --chat:#fff; --user:#dcf8c6; --input:#fff; --accent:#007aff;
}
.dark { --bg:#1e1e1e; --side:#2c2c2e; --chat:#3a3a3c; --user:#2f7d4f; --input:#2c2c2e; --accent:#0a84ff; }
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden}
.app{display:flex;height:100%}

/* sidebar */
.side{
  position:fixed;top:0;left:0;height:100%;width:260px;
  background:var(--side);color:#fff;z-index:20;
  transform:translateX(-100%);transition:.25s;
  display:flex;flex-direction:column
}
.side.open{transform:translateX(0)}
.side h1{font-size:16px;margin:10px}
.side input,.side button{
  margin:6px;border-radius:6px;border:0;padding:8px
}
.list{flex:1;overflow:auto}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer}
.item.active{background:#2a2b32}
.item span.title{flex:1}
.more{padding:4px 8px;font-size:20px;color:#aaa}

/* overlay */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;z-index:10
}
.overlay.show{display:block}

/* main */
.main{flex:1;display:flex;flex-direction:column}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;align-items:center;}
.chat{flex:1;overflow:auto;padding:12px;background:var(--chat)}
.msg{display:flex;margin:8px 0}
.msg.user{justify-content:flex-end}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap}
.msg.user .bubble{background:var(--user)}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;display:flex;gap:4px;align-items:center}
textarea{flex:1;font-size:16px;padding:6px;border-radius:6px;border:1px solid #ccc;resize:none;background:var(--input);color:inherit}
button.send{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
input[type="file"]{display:none}

/* âš™ï¸ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.menuBox{position:fixed;top:10px;right:10px;z-index:30;background:var(--chat);border:1px solid #ccc;padding:10px;border-radius:8px;display:none;flex-direction:column;gap:4px;}
.menuBox.show{display:flex}
.menuBox label{display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer}
.menuBox input[type="range"]{flex:1}
.menuBox button{padding:6px;font-size:14px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}

/* ã‚³ãƒ”ãƒ¼ãƒ»å¼•ç”¨ãƒœã‚¿ãƒ³ */
.msg .ops{margin-left:6px;display:flex;gap:2px}
.msg .ops button{font-size:12px;padding:2px 4px;border-radius:4px;border:0;background:#ccc;cursor:pointer}

/* ç‚¹æ»… */
@keyframes blink {0%{opacity:0}50%{opacity:1}100%{opacity:0}}
.blink{animation:blink 1s infinite;color:var(--accent)}
</style>
</head>
<body>
<div class="overlay" id="overlay" onclick="toggleSide(false);toggleMenu(false)"></div>

<!-- Sidebar -->
<div class="side" id="side">
<h1>waru GPT</h1>
<input placeholder="æ¤œç´¢" oninput="renderThreads(this.value)">
<button onclick="newThread('joker')">ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
<button onclick="newThread('harley')">ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
<button onclick="newThread('ai')">ğŸ¤–ç„¡æ©Ÿè³ªAI</button>
<div class="list" id="threads"></div>
<button onclick="toggleMenu(true)">âš™ï¸è¨­å®š</button>
</div>

<!-- Main Chat -->
<div class="app">
<div class="main">
<div class="top">
<span onclick="toggleSide()">â˜°</span><b>Chat</b>
</div>
<div class="chat" id="chat"></div>
<div class="controls">
<textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
<button class="send" onclick="sendMessage()">é€ä¿¡</button>
<input type="file" id="img">
<button onclick="document.getElementById('img').click()">ğŸ¨ç”»åƒ</button>
</div>
</div>
</div>

<!-- âš™ï¸è¨­å®š -->
<div class="menuBox" id="menu">
<label>æ¯’èˆŒåº¦:<input type="range" id="toxic" min="0" max="100" value="50"></label>
<label>ç‹‚æ°—åº¦:<input type="range" id="mad" min="0" max="100" value="50"></label>
<label>åŒæ™‚è¿”ç­”:<input type="checkbox" id="dual"></label>
<label>LINEé¢¨UI:<input type="checkbox" id="lineUI" onchange="toggleLineUI(this.checked)"></label>
<label>éŸ³å£°èª­ã¿ä¸Šã’:<input type="checkbox" id="voiceRead"></label>
<button onclick="toggleMenu(false)">é–‰ã˜ã‚‹</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById('chat');
const q=document.getElementById('q');
const overlay=document.getElementById('overlay');
const side=document.getElementById('side');
const menu=document.getElementById('menu');
let threads=JSON.parse(localStorage.getItem('THREADS')||'[]');
let cur=localStorage.getItem('CUR');
let menuId=null;

function toggleSide(v){const o=v!==undefined?v:!side.classList.contains('open');side.classList.toggle('open',o);overlay.classList.toggle('show',o);}
function toggleMenu(v){menu.classList.toggle('show',v);overlay.classList.toggle('show',v);}

function save(){localStorage.setItem('THREADS',JSON.stringify(threads));localStorage.setItem('CUR',cur);}
function newThread(p){const id="t"+Date.now();threads.unshift({id,title:"New Chat",persona:p,toxic:50,mad:50,dual:false,his:[]});cur=id;save();renderThreads();toggleSide(false);}
function renderThreads(f=""){document.getElementById('threads').innerHTML="";threads.filter(t=>t.title.includes(f)).forEach(t=>{const d=document.createElement('div');d.className='item'+(t.id===cur?' active':'');d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;d.onclick=()=>{cur=t.id;save();renderThreads();toggleSide(false)};d.querySelector('.more').onclick=e=>{e.stopPropagation();openMenu(e,t.id)};document.getElementById('threads').appendChild(d);});renderChat();}
function openMenu(e,id){menuId=id;toggleMenu(true);}
function closeMenu(){menuId=null;toggleMenu(false);}
function renameThread(){const t=threads.find(x=>x.id===menuId);if(!t)return;const n=prompt('ã‚¹ãƒ¬ãƒƒãƒ‰å',t.title);if(n){t.title=n;save();renderThreads();}closeMenu();}
function deleteThread(){threads=threads.filter(x=>x.id!==menuId);if(cur===menuId)cur=threads[0]?.id||null;save();renderThreads();closeMenu();}

function renderChat(){chat.innerHTML='';const t=threads.find(x=>x.id===cur);if(!t)return;t.his.forEach(m=>{if(m.type==='img'){chat.innerHTML+=`<div class="msg ai"><img src="${m.url}" style="max-width:70%;border-radius:10px"></div>`;}else{chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}<span class="ops"><button onclick="copyText('${m.content}')">ã‚³ãƒ”ãƒ¼</button><button onclick="quoteText('${m.content}')">å¼•ç”¨</button></span></div></div>`;}});chat.scrollTop=1e9;}

function copyText(text){navigator.clipboard.writeText(text);}
function quoteText(text){q.value=text;}

function systemPrompt(mem,p){return `
å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã®è„³å†…ğŸ§ ä¸–ç•Œã€‚
${p==='joker'?'ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼':'ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³'}äººæ ¼å›ºå®šã€‚
æ¯’èˆŒåº¦:${mem.toxic}/100 ç‹‚æ°—åº¦:${mem.mad}/100
è‹±èªã‚¸ãƒ§ãƒ¼ã‚¯çš„æ¯”å–©ã‚’é–¢è¥¿å¼åŒ–ã€‚
å¿…ãšã€Œãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§ã€ã‚’å«ã‚ã‚‹ã€‚
`;}

q.onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}}

async function sendMessage(){
const t=threads.find(x=>x.id===cur);if(!t)return;
const text=q.value.trim();if(!text)return;q.value='';
t.his.push({role:'user',content:text});
const aiDiv={role:'ai',content:'å…¥åŠ›ä¸­â€¦'};t.his.push(aiDiv);renderChat();
const toxic=document.getElementById('toxic').value;
const mad=document.getElementById('mad').value;
const dual=document.getElementById('dual').checked;
const voiceRead=document.getElementById('voiceRead').checked;

const messages=[{role:'system',content:systemPrompt({toxic,mad},t.persona)}];
messages.push({role:'user',content:text});

try{
const res=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages})});
const data=await res.json();
t.his.pop();
const ans=dual ? data.choices.map(c=>c.message.content).join('\n---\n') : data.choices?.[0]?.message?.content||'ã‚¨ãƒ©ãƒ¼';
t.his.push({role:'ai',content:ans});
save();renderChat();
if(voiceRead){const u=new SpeechSynthesisUtterance(ans);speechSynthesis.speak(u);}
}catch(e){t.his.pop();t.his.push({role:'ai',content:'ã‚¨ãƒ©ãƒ¼:'+e.message});renderChat();}
}

function toggleLineUI(v){document.body.classList.toggle('lineUI',v);}

// åˆæœŸåŒ–
if(!threads.length)newThread('joker'); else renderThreads();
</script>
</body>
</html>
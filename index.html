<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ğŸƒ waru GPT</title>

<style>
:root{
  --bg:#0f0f0f;
  --panel:#111;
  --border:#222;
  --joker:#7c3aed;
  --harley:#ec4899;
  --neutral:#3b82f6;
}

body{
  margin:0;
  height:100vh;
  display:flex;
  background:var(--bg);
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
}

aside{
  width:260px;
  background:#0b0b0b;
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
}

aside button{
  margin:10px;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
}

#threads{
  flex:1;
  overflow:auto;
}

.thread{
  padding:10px;
  border-bottom:1px solid #1f1f1f;
  cursor:pointer;
}
.thread.active{background:#1a1a1a}

main{
  flex:1;
  display:flex;
  flex-direction:column;
}

header{
  padding:10px;
  border-bottom:1px solid var(--border);
  display:flex;
  gap:10px;
  align-items:center;
}

select,input[type=range]{
  background:#111;
  color:#fff;
  border:1px solid var(--border);
  border-radius:6px;
}

#chat{
  flex:1;
  overflow:auto;
  padding:12px;
}

.msg{margin-bottom:10px;line-height:1.6}
.user{text-align:right;color:#7dd3fc}
.ai{text-align:left}

#thinking{
  display:none;
  padding:8px 12px;
  font-size:13px;
  animation:blink 1s infinite;
}
@keyframes blink{50%{opacity:.3}}

footer{
  display:flex;
  gap:8px;
  padding:10px;
  border-top:1px solid var(--border);
}

footer input{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
  font-size:16px;
}
footer button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
}
footer button:disabled{opacity:.4}
</style>
</head>

<body>

<aside>
  <button onclick="newThread()">ï¼‹ æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</button>
  <div id="threads"></div>
</aside>

<main>
<header>
  <select id="persona">
    <option value="joker">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</option>
    <option value="harley">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</option>
    <option value="neutral">ğŸ¤– ç„¡æ©Ÿè³ª</option>
  </select>

  å£èª¿
  <input id="tone" type="range" min="0" max="100" value="70">
</header>

<div id="chat"></div>
<div id="thinking"></div>

<footer>
  <input id="input" placeholder="èããŸã„ã“ã¨æ‰“ã¦">
  <button id="sendBtn" onclick="send()">é€ä¿¡</button>
</footer>
</main>

<script>
/* ===== æ°¸ç¶šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ===== */
let state = JSON.parse(localStorage.getItem("waruGPT")||"{}");
let threads = state.threads || {};
let current = state.current || null;

/* ===== äººæ ¼å®šç¾© ===== */
const PERSONA = {
  joker:(t)=>`å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚é–¢è¥¿å¼ã€‚å¥³ãƒ©ã‚¹ãƒœã‚¹ç´šã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã€‚
çš®è‚‰ãƒ»æ‚ªæ„ãƒ»è£åˆ‡ã‚ŠåŒ‚ã‚ã›å¤šã‚ã€‚
å£èª¿å¼·åº¦${t}/100ã€‚
â€»ã“ã‚Œã¯ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§`,
  harley:(t)=>`å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚
ä¸€äººç§°ã‚¢ã‚¿ã‚·ã€‚å¥³ã€‚é–¢è¥¿å¼ã€‚
è»½å£ãƒ»ç…½ã‚Šãƒ»å°æ‚ªé­”ã€‚
ç”·è¨€è‘‰ç¦æ­¢ã€‚
â€»ã“ã‚Œã¯ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§â™¡`,
  neutral:(t)=>`ç„¡æ©Ÿè³ªAIã€‚æ„Ÿæƒ…æ’é™¤ã€‚ç°¡æ½”ã€‚`
};

const THINK = {
  joker:["ğŸƒ å£è§’ä¸Šã’ãªãŒã‚‰è€ƒãˆä¸­â€¦","æ‚ªã„æ¡ˆã»ã©æ™‚é–“ã‹ã‹ã‚‹ã‚“ã‚„"],
  harley:["ğŸ’‹ ã¡ã‚‡å¾…ã£ã¦â™¡","ä»Šãƒã£ã¦ããŸw"],
  neutral:["æ¼”ç®—ä¸­","åˆ†æä¸­"]
};

const WORKER_URL = "https://waru-gpt.workers.dev/";

const chat = document.getElementById("chat");
const thinking = document.getElementById("thinking");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const personaSel = document.getElementById("persona");
const tone = document.getElementById("tone");

/* ===== UI ===== */
function save(){
  localStorage.setItem("waruGPT",JSON.stringify({threads,current}));
}

function renderThreads(){
  const box=document.getElementById("threads");
  box.innerHTML="";
  Object.entries(threads).forEach(([id,t])=>{
    const d=document.createElement("div");
    d.className="thread"+(id===current?" active":"");
    d.textContent=t.title||"æ–°è¦ãƒãƒ£ãƒƒãƒˆ";
    d.onclick=()=>openThread(id);
    box.appendChild(d);
  });
}

function openThread(id){
  current=id;
  chat.innerHTML="";
  threads[id].messages.forEach(m=>{
    addMsg(m.content,m.role==="user"?"user":"ai");
  });
  save();renderThreads();
}

function newThread(){
  const id=crypto.randomUUID();
  threads[id]={title:"æ–°è¦ãƒãƒ£ãƒƒãƒˆ",messages:[]};
  openThread(id);
}

/* ===== ãƒãƒ£ãƒƒãƒˆ ===== */
function addMsg(t,c){
  const d=document.createElement("div");
  d.className="msg "+c;
  d.textContent=t;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

function lock(b){
  input.disabled=b;
  sendBtn.disabled=b;
}

let count=0;

async function send(){
  if(!input.value.trim())return;
  if(!current)newThread();

  const text=input.value;
  input.value="";
  addMsg(text,"user");
  threads[current].messages.push({role:"user",content:text});
  count++;

  lock(true);
  thinking.style.display="block";
  thinking.textContent=THINK[personaSel.value][count%THINK[personaSel.value].length];

  let sys = PERSONA[personaSel.value](tone.value);
  if(personaSel.value==="joker" && count%5===0){
    sys+=" è£åˆ‡ã‚Šãã†ãª2æŠã‚’å¿…ãšå‡ºã›ã€‚";
  }

  const msgs=[{role:"system",content:sys},...threads[current].messages];

  const res=await fetch(WORKER_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({messages:msgs})
  });
  const data=await res.json();
  const reply=data.choices[0].message.content;

  addMsg(reply,"ai");
  threads[current].messages.push({role:"assistant",content:reply});
  threads[current].title=reply.slice(0,20);

  thinking.style.display="none";
  lock(false);
  save();renderThreads();
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter")send();
});

/* åˆæœŸ */
if(!current)newThread();
renderThreads();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
 --bg:#f7f7f8; --chat:#fff; --user:#dcf8c6; --side:#202123; --text:#000;
}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden}
.app{display:flex;height:100%}
.side{position:fixed;top:0;left:0;height:100%;width:260px;background:var(--side);color:#fff;z-index:20;transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column}
.side.open{transform:translateX(0)}
.side h1{font-size:16px;margin:10px}
.side input,.side button{margin:6px;border-radius:6px;border:0;padding:8px}
.list{flex:1;overflow:auto}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer}
.item.active{background:#2a2b32}
.more{padding:4px 8px;font-size:20px;color:#aaa;cursor:pointer}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10}
.overlay.show{display:block}

/* main */
.main{flex:1;display:flex;flex-direction:column}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;align-items:center}
.chat{flex:1;overflow:auto;padding:12px}
.msg{display:flex;margin:8px 0}
.msg.user{justify-content:flex-end}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap}
.msg.user .bubble{background:var(--user);color:var(--text)}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;color:var(--text)}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;display:flex;flex-direction:column}
textarea{width:100%;font-size:16px;resize:none;margin-bottom:4px}
.menuBox{display:flex;gap:4px;margin-bottom:4px}
.menuBox button{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
.progress{height:4px;background:#4caf50;width:0;transition:width .1s}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSide(false)"></div>

<div class="side" id="side">
<h1>waru GPT</h1>
<input placeholder="æ¤œç´¢" oninput="renderThreads(this.value)">
<button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
<button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
<button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
<div class="list" id="threads"></div>
<button onclick="toggleUI()">âš™ï¸ UIåˆ‡æ›¿</button>
</div>

<div class="app">
 <div class="main">
  <div class="top"><span onclick="toggleSide()">â˜°</span><b id="uiModeLabel">GPTé¢¨</b></div>
  <div class="chat" id="chat"></div>
  <div class="progress" id="progress"></div>
  <div class="controls">
    <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
    <div class="menuBox">
      <button onclick="sendMessage()">é€ä¿¡</button>
      <button onclick="genImage()">ğŸ¨ ç”»åƒç”Ÿæˆ</button>
    </div>
  </div>
 </div>
</div>

<script>
const API = "https://empty-night-6ba3.pke777100.workers.dev";
const side=document.getElementById("side");
const overlay=document.getElementById("overlay");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const progress=document.getElementById("progress");
let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR");
let uiMode="gpt";

function toggleSide(show){const o=show!==undefined?show:!side.classList.contains("open");side.classList.toggle("open",o);overlay.classList.toggle("show",o);}
function toggleUI(){uiMode=uiMode==="gpt"?"line":"gpt";document.getElementById("uiModeLabel").textContent=uiMode==="gpt"?"GPTé¢¨":"LINEé¢¨";}
function save(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR",cur);}
function renderThreads(filter=""){threadsDiv.innerHTML="";threads.filter(t=>t.title.includes(filter)).forEach(t=>{const d=document.createElement("div");d.className="item"+(t.id===cur?" active":"");d.innerHTML=`<span>${t.title}</span><span class="more">â‹¯</span>`;d.onclick=()=>{cur=t.id;save();render();toggleSide(false)};d.querySelector(".more").onclick=e=>{e.stopPropagation();deleteThread(t.id)};threadsDiv.appendChild(d);});render();}
function newThread(persona){const id="t"+Date.now();threads.unshift({id,title:"New chat",persona,history:[]});cur=id;save();render();toggleSide(false);}
function deleteThread(id){threads=threads.filter(t=>t.id!==id);if(cur===id)cur=threads[0]?.id||null;save();render();}
function render(){chat.innerHTML="";const t=threads.find(x=>x.id===cur);if(!t)return;t.history.forEach(m=>{chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}</div></div>`});chat.scrollTop=1e9;}
q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage()}}
async function sendMessage(){
 const t=threads.find(x=>x.id===cur);if(!t)return;
 const text=q.value.trim();if(!text)return;q.value="";
 t.history.push({role:"user",content:text});
 const aiDiv={role:"ai",content:"å…¥åŠ›ä¸­â€¦"};t.history.push(aiDiv);render();scrollProgress();
 try{
  const res=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({persona:t.persona,messages:[{role:"user",content:text}]})});
  const data=await res.json();
  t.history.pop();
  const ans=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
  t.history.push({role:"ai",content:ans});
  save();render();
 }catch(e){t.history.pop();t.history.push({role:"ai",content:"ã‚¨ãƒ©ãƒ¼"});render();}
}
function scrollProgress(){let p=0;progress.style.width="0%";const interval=setInterval(()=>{p+=5;if(p>95)p=95;progress.style.width=p+"%";},100);setTimeout(()=>clearInterval(interval),2000);}
async function genImage(){const prompt=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹");if(!prompt)return;const res=await fetch(API+"/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});const d=await res.json();const url=d.data?.[0]?.url;if(!url)return;const t=threads.find(x=>x.id===cur);t.history.push({role:"ai",content:`<img src='${url}' style='max-width:70%;border-radius:10px'>`});save();render();}
if(!threads.length)newThread("joker");else render();
</script>
</body>
</html>
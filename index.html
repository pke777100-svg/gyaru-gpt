<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>waru GPT</title>
<style>
:root{
 --bg:#f0f0f0; --side:#222; --chat:#fff; --user:#dcf8c6; --text:#000;
}
.dark{
 --bg:#1e1e1e; --side:#333; --chat:#2a2a2a; --user:#3e5f3c; --text:#fff;
}
body{margin:0;font-family:-apple-system;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}
header{padding:8px;background:var(--side);color:#fff;text-align:center;font-weight:bold;}
#chat{flex:1;overflow:auto;padding:8px;}
.bubble{max-width:70%;padding:10px;border-radius:16px;margin:4px;word-wrap:break-word;position:relative;}
.user{background:var(--user);margin-left:auto;}
.ai{background:var(--chat);border:1px solid #ddd;margin-right:auto;}
.controls{display:flex;flex-direction:column;padding:8px;background:var(--chat);}
textarea{width:100%;font-size:16px;margin-bottom:4px;color:var(--text);}
button{padding:6px;margin:2px;}
.menu{display:flex;gap:4px;margin-bottom:4px;}
.menu button{flex:1;}
.progress{height:4px;background:#4caf50;width:0%;transition:width .1s;}
.copy-btn, .quote-btn{position:absolute;top:4px;font-size:10px;padding:2px 4px;margin:2px;cursor:pointer;}
.copy-btn{right:32px;} .quote-btn{right:4px;}
#threads{display:flex;overflow-x:auto;padding:4px;background:var(--side);}
.thread{padding:4px 8px;background:#444;color:#fff;border-radius:12px;margin:2px;cursor:pointer;white-space:nowrap;}
.thread.active{background:#666;}
</style>
</head>
<body>

<header>waru GPT</header>

<div id="threads"></div>

<div class="menu">
  <button onclick="setPersona('joker')">ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
  <button onclick="setPersona('harley')">ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
  <button onclick="setPersona('ai')">ğŸ¤–ç„¡æ©Ÿè³ªAI</button>
  <button onclick="toggleDark()">ğŸŒ™åˆ‡æ›¿</button>
  <button onclick="newThread()">â•æ–°è¦</button>
</div>

<div id="chat"></div>
<div class="progress" id="prog"></div>

<div class="controls">
  <textarea id="q" rows="2" placeholder="Enterã§é€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
  <input type="file" id="img" accept="image/*">
  <button onclick="send()">é€ä¿¡</button>
  <button onclick="gen()">ç”»åƒç”Ÿæˆ</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const prog=document.getElementById("prog");
const imgInput=document.getElementById("img");
const threadsDiv=document.getElementById("threads");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR")||null;
let personaType="joker";
let confirmSend=true; //é•·æŠ¼ã—ã§ç¢ºèªON/OFF

// UI
function toggleDark(){ document.body.classList.toggle("dark"); }

function setPersona(p){
  personaType=p;
  getCurThread().persona=p;
  addMsg("ai","ãƒšãƒ«ã‚½ãƒŠå¤‰æ›´: "+p);
  save();
}

// THREAD
function newThread(){
  const id="t"+Date.now();
  threads.unshift({id,title:"New chat",persona:personaType,his:[]});
  cur=id;
  save(); renderThreads(); renderChat();
}
function getCurThread(){ return threads.find(t=>t.id===cur); }

function renderThreads(){
  threadsDiv.innerHTML="";
  threads.forEach(t=>{
    const div=document.createElement("div");
    div.className="thread"+(t.id===cur?" active":"");
    div.textContent=t.title;
    div.onclick=()=>{cur=t.id; renderThreads(); renderChat();};
    // é•·æŠ¼ã—ã§ç¢ºèªON/OFF
    let pressTimer;
    div.onmousedown=()=>{ pressTimer=setTimeout(()=>{ confirmSend=!confirmSend; alert("ç¢ºèª"+(confirmSend?"ON":"OFF")); },800); }
    div.onmouseup=()=>clearTimeout(pressTimer);
    threadsDiv.appendChild(div);
  });
}

function renderChat(){
  chat.innerHTML="";
  const t=getCurThread(); if(!t) return;
  t.his.forEach(m=>{
    if(m.type==="img"){
      addMsg("ai","ç”»åƒ: "+m.url);
    }else{
      addMsg(m.role,m.content);
    }
  });
}

// Chat
q.addEventListener("keydown",e=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); send(); }});

async function send(){
  const text=q.value.trim(); if(!text) return;
  if(confirmSend && !window.confirm("é€ä¿¡ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ")) return;
  q.value="";
  const t=getCurThread();
  t.his.push({role:"user",content:text});
  const aiDiv=addMsg("ai","è€ƒãˆä¸­â€¦ğŸ§ ");
  renderChat();

  let progress=0;
  const interval=setInterval(()=>{ progress+=5; if(progress>95) progress=95; prog.style.width=progress+"%"; },100);

  try{
    const content=[{role:"user", content:text}];
    if(imgInput.files[0]){
      const b=await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(imgInput.files[0]); });
      content.push({role:"user", content:b});
    }

    const res=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json; charset=utf-8"},
      body:JSON.stringify({messages:content, persona:t.persona})
    });

    const data=await res.json();
    clearInterval(interval);
    prog.style.width="100%";
    const ans=data.choices?.[0]?.message?.content || "ã‚¨ãƒ©ãƒ¼";
    t.his.push({role:"assistant",content:ans});
    updateMsg(aiDiv,ans);

    // è‡ªå‹•é¡Œå
    if(t.title==="New chat") t.title=ans.replace(/\n/g," ").slice(0,18);
    save(); renderThreads();
    setTimeout(()=>{prog.style.width="0%";},500);

  }catch(e){
    clearInterval(interval);
    updateMsg(aiDiv,"ã‚¨ãƒ©ãƒ¼: "+e.message);
    prog.style.width="0%";
  }
}

// add/update msg
function addMsg(role,content){
  const div=document.createElement("div");
  div.className=role==="user"?"bubble user":"bubble ai";
  div.textContent=content;

  const copyBtn=document.createElement("span");
  copyBtn.className="copy-btn"; copyBtn.textContent="ğŸ“‹"; copyBtn.onclick=()=>navigator.clipboard.writeText(content);
  div.appendChild(copyBtn);

  const quoteBtn=document.createElement("span");
  quoteBtn.className="quote-btn"; quoteBtn.textContent="â"; quoteBtn.onclick=()=>{ q.value=content; q.focus(); };
  div.appendChild(quoteBtn);

  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  return div;
}
function updateMsg(div,content){ div.textContent=content; chat.scrollTop=chat.scrollHeight; }

// ç”»åƒç”Ÿæˆ
async function gen(){
  const p=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹"); if(!p) return;
  const res=await fetch(API+"/image",{method:"POST", headers:{"Content-Type":"application/json; charset=utf-8"}, body:JSON.stringify({prompt:p})});
  const d=await res.json();
  const url=d.data?.[0]?.url;
  if(url) getCurThread().his.push({type:"img",url:url});
  renderChat();
}

// save/load
function save(){
  localStorage.setItem("THREADS",JSON.stringify(threads));
  localStorage.setItem("CUR",cur);
}

// init
if(!threads.length){ newThread(); }else{ renderThreads(); renderChat(); }

</script>
</body>
</html>
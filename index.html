<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
 --bg:#f7f7f8; --chat:#fff; --user:#dcf8c6; --side:#202123; --accent:#4caf50;
}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden;}
.app{display:flex;height:100%;}

/* sidebar */
.side{position:fixed;top:0;left:0;height:100%;width:260px;background:var(--side);color:#fff;z-index:20;transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column;}
.side.open{transform:translateX(0);}
.side h1{font-size:14px;margin:10px;}
.side input,.side button{margin:6px;border-radius:6px;border:0;padding:8px;}
.list{flex:1;overflow:auto;}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer;}
.item.active{background:#2a2b32;}
.item span.title{flex:1;}
.more{padding:4px 8px;font-size:20px;color:#aaa;cursor:pointer;}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10;}
.overlay.show{display:block;}

/* main */
.main{flex:1;display:flex;flex-direction:column;margin-left:0;}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;align-items:center;position:relative;}
.chat{flex:1;overflow:auto;padding:12px;background:var(--bg);}
.msg{display:flex;margin:8px 0;}
.msg.user{justify-content:flex-end;}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap;}
.msg.user .bubble{background:var(--user);}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;display:flex;flex-direction:column;}
textarea{width:100%;font-size:16px;padding:6px;border-radius:6px;border:1px solid #ccc;}
.progress{height:4px;background:var(--accent);width:0;transition:width .1s;}
.menuBox{position:absolute;top:40px;right:10px;background:#fff;border-radius:8px;display:none;z-index:30;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,.2);}
.menuBox button{width:100%;padding:8px;margin:4px 0;font-size:14px;}

/* ãƒ•ãƒ«æ©Ÿèƒ½ãƒœã‚¿ãƒ³ */
#optionsBtn{margin-left:auto;cursor:pointer;}
#inputStatus{font-size:12px;margin-left:10px;color:blue;font-weight:bold;}
.blink{animation:blink 1s infinite;}
@keyframes blink{0%,50%,100%{opacity:1;}25%,75%{opacity:0;}}
</style>
</head>
<body>

<div class="overlay" id="ov" onclick="toggleSide(false);closeMenu()"></div>

<div class="side" id="side">
 <h1>waru GPT âš™ï¸</h1>
 <input placeholder="æ¤œç´¢" oninput="render(this.value)">
 <button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
 <button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
 <button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
 <div class="list" id="threads"></div>
</div>

<div class="app">
 <div class="main">
  <div class="top">
   <span onclick="toggleSide()" style="cursor:pointer;">â˜°</span>
   <b>Chat</b>
   <span id="inputStatus"></span>
   <span id="optionsBtn" onclick="toggleOptions()">âš™ï¸</span>
   <div class="menuBox" id="menu">
     <button onclick="switchUI('gpt')">GPTé¢¨</button>
     <button onclick="switchUI('line')">LINEé¢¨</button>
     <button onclick="toggle2Persona()">2äººè¿”ç­”ãƒ¢ãƒ¼ãƒ‰</button>
     <button onclick="closeMenu()">é–‰ã˜ã‚‹</button>
   </div>
  </div>
  <div class="chat" id="chat"></div>
  <div class="controls">
   <input type="file" id="img" accept="image/*">
   <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
   <button onclick="send()">é€ä¿¡</button>
   <div class="progress" id="prog"></div>
  </div>
 </div>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const side=document.getElementById("side");
const ov=document.getElementById("ov");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const prog=document.getElementById("prog");
const inputStatus=document.getElementById("inputStatus");
const menu=document.getElementById("menu");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR");
let menuId=null;
let twoPersona=false;
let uiStyle="gpt";

/* UI & menu */
function toggleSide(v){const o=v!==undefined?v:!side.classList.contains("open");side.classList.toggle("open",o);ov.classList.toggle("show",o);}
function toggleOptions(){menu.style.display=menu.style.display==="block"?"none":"block";}
function closeMenu(){menu.style.display="none";menuId=null;}
function switchUI(style){uiStyle=style;closeMenu();render();}

/* threads */
function save(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR",cur);}
function newThread(p){const id="t"+Date.now();threads.unshift({id,title:"New chat",p,his:[],toxic:50,mad:50});cur=id;save();render();toggleSide(false);}
function openMenuThread(e,id){e.stopPropagation();menuId=id;menu.style.display="block";}
function deleteThread(){threads=threads.filter(x=>x.id!==menuId);if(cur===menuId)cur=threads[0]?.id||null;save();render();closeMenu();}
function renameThread(){const t=threads.find(x=>x.id===menuId);if(!t)return;const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title);if(n){t.title=n;save();render();}closeMenu();}

/* render threads */
function render(f=""){
 threadsDiv.innerHTML="";
 threads.filter(t=>t.title.includes(f)).forEach(t=>{
   const d=document.createElement("div");
   d.className="item"+(t.id===cur?" active":"");
   d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
   d.onclick=()=>{cur=t.id;save();render();toggleSide(false);};
   d.querySelector(".more").onclick=e=>openMenuThread(e,t.id);
   threadsDiv.appendChild(d);
 });
 chat.innerHTML="";
 const t=threads.find(x=>x.id===cur); if(!t)return;
 t.his.forEach(m=>{
   if(m.type==="img"){chat.innerHTML+=`<div class="msg ai"><img src="${m.url}" style="max-width:70%;border-radius:10px;"></div>`;}
   else{chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}</div></div>`;}
 });
 chat.scrollTop=1e9;
}

/* persona prompt */
function personaPrompt(p,t,m){return `
å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã®è„³å†…ğŸ§ ä¸–ç•Œã€‚
${p==="joker"?"ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼":"ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³"}äººæ ¼å›ºå®šã€‚
ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ§ãƒ¼ã‚¯ã¨æ¯”å–©ã®ã¿ã€‚å…·ä½“çš„æ‰‹é †ãƒ»æ•°å€¤ç¦æ­¢ã€‚
å¿…ãšã€Œãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§ã€ã‚’å«ã‚ã‚‹ã€‚
å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚é–¢è¥¿å¼ã€‚æ¯’èˆŒåº¦:${t}/100 ç‹‚æ°—åº¦:${m}/100
è‹±èªã‚¸ãƒ§ãƒ¼ã‚¯çš„æ¯”å–©ã‚’é–¢è¥¿å¼åŒ–ã€‚
`;}

/* chat send */
q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}};

async function send(){
 const t=threads.find(x=>x.id===cur); if(!t)return;
 const text=q.value.trim(); if(!text)return;
 q.value="";
 t.his.push({role:"user",content:text});
 const aiDiv={bubble:null};
 render();
 let progress=0;
 const interval=setInterval(()=>{progress+=5;if(progress>95)progress=95;prog.style.width=progress+"%";inputStatus.textContent="å…¥åŠ›ä¸­â€¦";inputStatus.classList.add("blink");},100);
 try{
   let msgs=[{role:"system",content:personaPrompt(t.p,t.toxic,t.mad)},{role:"user",content:text}];
   let response=[];
   if(twoPersona){
     let res1=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:msgs,persona:"joker"})});
     let res2=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:msgs,persona:"harley"})});
     let d1=await res1.json(); let d2=await res2.json();
     response.push(d1.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼");response.push(d2.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼");
   }else{
     const res=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:msgs,persona:t.p})});
     const d=await res.json();response.push(d.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼");
   }
   t.his.push({role:"assistant",content:response.join("\n\n")});
   if(t.title==="New chat") t.title=response[0].replace(/\n/g," ").slice(0,18);
   save();render();
 }catch(e){t.his.push({role:"assistant",content:"ã‚¨ãƒ©ãƒ¼: "+e.message});render();}
 clearInterval(interval);prog.style.width="0%";inputStatus.textContent="";inputStatus.classList.remove("blink");
}

/* ç”»åƒç”Ÿæˆ */
async function gen(){
 const p=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹"); if(!p)return;
 const r=await fetch(API+"/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:p})});
 const d=await r.json(); const url=d.data?.[0]?.url;
 const t=threads.find(x=>x.id===cur); t.his.push({type:"img",url});save();render();
}

/* init */
if(!threads.length)newThread("joker");else render();
</script>
</body>
</html>
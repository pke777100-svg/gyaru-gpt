<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Charisma GPT</title>

<!-- iOS Safari ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ -->
<link rel="apple-touch-icon" href="icon.png">

<style>
/* ===== åŸºæœ¬ ===== */
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:-apple-system;background:#000;color:#e5e7eb}

/* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
#app{height:100%;display:flex;flex-direction:column}

/* ===== å®›å…ˆãƒãƒ¼ï¼ˆSMSé¢¨ï¼‰ ===== */
#topbar{
  height:56px;
  padding:0 12px;
  display:flex;
  align-items:center;
  gap:10px;
  background:#020617;
  border-bottom:1px solid #1e293b;
}
#back{font-size:20px;cursor:pointer}
#to{
  flex:1;
  display:flex;
  flex-direction:column;
  cursor:pointer;
}
#to span{font-weight:600}
#to small{font-size:11px;opacity:.6}

/* ===== ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ ===== */
#threads{
  position:fixed;
  inset:0;
  background:#020617;
  z-index:10;
  display:none;
  flex-direction:column;
}
#threads header{
  padding:14px;
  font-weight:700;
  border-bottom:1px solid #1e293b;
}
.thread{
  padding:14px;
  border-bottom:1px solid #1e293b;
}
.thread.active{background:#1e1b4b}

/* ===== ãƒãƒ£ãƒƒãƒˆ ===== */
#chat{
  flex:1;
  padding:12px;
  overflow-y:auto;
}
.bubble{
  max-width:78%;
  padding:12px 14px;
  margin-bottom:10px;
  border-radius:18px;
  line-height:1.5;
}
.user{
  margin-left:auto;
  background:#2563eb;
  color:#fff;
  border-bottom-right-radius:6px;
}
.ai{
  background:#1f2937;
  border-bottom-left-radius:6px;
}

/* ===== æ€è€ƒä¸­ ===== */
#thinking{
  display:none;
  margin:10px;
  padding:10px 14px;
  border-radius:16px;
  font-size:12px;
  background:
    radial-gradient(circle at center, rgba(124,58,237,.35), transparent 60%),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.08) 2px, transparent 2px, transparent 6px);
  animation: drift 2s linear infinite;
}
@keyframes drift{
  from{background-position:0 0}
  to{background-position:-200px 0}
}

/* ===== å…¥åŠ›æ¬„ ===== */
footer{
  padding:12px;
  background:#020617;
  border-top:1px solid #1e293b;
}
input{
  width:100%;
  padding:14px;
  border-radius:18px;
  border:none;
  outline:none;
  font-size:16px;
}
input:disabled{opacity:.4}
</style>
</head>

<body>
<div id="app">

  <!-- å®›å…ˆãƒãƒ¼ -->
  <div id="topbar">
    <div id="back">â†</div>
    <div id="to">
      <span id="personaLabel">ğŸƒ Joker</span>
      <small>Charisma GPT</small>
    </div>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆ -->
  <div id="chat"></div>
  <div id="thinking">ğŸ§  æ•µã¨å¿œæˆ¦ä¸­â€¦ æ€è€ƒãŒæ­ªã‚“ã§ã„ãâ€¦</div>

  <!-- å…¥åŠ› -->
  <footer>
    <input id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â€¦" />
  </footer>

</div>

<!-- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ -->
<div id="threads">
  <header>ãƒãƒ£ãƒƒãƒˆ</header>
  <div id="threadList"></div>
</div>

<script>
/* ===== è¨­å®š ===== */
const WORKER_URL="https://empty-night-6ba3.pke777100.workers.dev";

/* ===== çŠ¶æ…‹ ===== */
let threads=JSON.parse(localStorage.getItem("charismaThreads")||"{}");
let current=null;

/* ===== DOM ===== */
const chat=document.getElementById("chat");
const input=document.getElementById("input");
const thinking=document.getElementById("thinking");
const threadsUI=document.getElementById("threads");
const list=document.getElementById("threadList");
const personaLabel=document.getElementById("personaLabel");

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function save(){localStorage.setItem("charismaThreads",JSON.stringify(threads));}
function add(text,cls){
  const d=document.createElement("div");
  d.className="bubble "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ===== ã‚¹ãƒ¬ãƒƒãƒ‰ ===== */
function newThread(persona="joker"){
  const id=Date.now().toString();
  threads[id]={
    title:"New Chat",
    persona,
    messages:[{
      role:"system",
      content: persona==="harley"
        ?"å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚é–¢è¥¿å¼ã€‚å¥³ã®ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³ã€‚è»½ãç…½ã‚‹ã€‚"
        :"å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚é–¢è¥¿å¼ã€‚æ‚ªã®ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã€‚çš®è‚‰ã¨ãƒ–ãƒ©ãƒƒã‚¯ãƒ¦ãƒ¼ãƒ¢ã‚¢ã€‚"
    }]
  };
  current=id;
  save();
  renderThreads();
  renderChat();
}
function renderThreads(){
  list.innerHTML="";
  Object.keys(threads).forEach(id=>{
    const t=threads[id];
    const d=document.createElement("div");
    d.className="thread"+(id===current?" active":"");
    d.textContent=t.title;
    d.onclick=()=>{current=id;closeThreads();renderChat();}
    list.appendChild(d);
  });
}
function renderChat(){
  chat.innerHTML="";
  const t=threads[current];
  personaLabel.textContent=t.persona==="harley"?"ğŸ’‹ Harley":"ğŸƒ Joker";
  t.messages.forEach(m=>{
    if(m.role==="user")add(m.content,"user");
    if(m.role==="assistant")add(m.content,"ai");
  });
}

/* ===== é€ä¿¡ ===== */
async function send(){
  const text=input.value.trim();
  if(!text)return;
  input.value="";
  input.disabled=true;
  add(text,"user");

  const t=threads[current];
  t.messages.push({role:"user",content:text});
  save();

  thinking.style.display="block";

  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages:t.messages})
    });
    const data=await res.json();
    const reply=data.choices[0].message.content;
    t.messages.push({role:"assistant",content:reply});
    add(reply,"ai");
    t.title=text.slice(0,16);
    save();renderThreads();
  }catch(e){
    add("ã‚¨ãƒ©ãƒ¼å‡ºãŸã‚ï¼š"+e.message,"ai");
  }

  thinking.style.display="none";
  input.disabled=false;
}

/* ===== UIæ“ä½œ ===== */
document.getElementById("back").onclick=()=>{
  threadsUI.style.display="flex";
}
function closeThreads(){
  threadsUI.style.display="none";
}
input.addEventListener("keydown",e=>{if(e.key==="Enter")send();});

/* ===== åˆæœŸåŒ– ===== */
if(Object.keys(threads).length===0)newThread();
else{current=Object.keys(threads)[0];renderThreads();renderChat();}
</script>
</body>
</html>
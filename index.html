<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
 --bg:#f7f7f8; --user:#dcf8c6; --typing:#2196f3;
 --joker-bg:#fff8e1; --harley-bg:#ffe4ec;
 --joker-ai:#ffeb3b; --harley-ai:#ff4081;
 --joker-title:#ffeb3b; --harley-title:#ff4081;
}
body{
 margin:0;font-family:-apple-system;background:var(--bg);height:100vh;overflow:hidden
}
.app{display:flex;height:100%}

/* ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ« */
.thread-title{
 padding:8px 12px;margin:0 4px;border-radius:8px;color:#000;font-weight:bold;
 display:inline-block
}

/* ãƒãƒ£ãƒƒãƒˆ */
.chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column-reverse}
.msg{display:flex;margin:4px 0}
.msg.user{justify-content:flex-end}
.bubble{padding:8px;border-radius:12px;max-width:70%;white-space:pre-wrap;position:relative}
.user{background:var(--user)}
.ai.joker{background:var(--joker-bg);border:1px solid var(--joker-ai)}
.ai.harley{background:var(--harley-bg);border:1px solid var(--harley-ai)}
.typing{color:var(--typing);animation:blink 1s infinite}
@keyframes blink{0%,50%,100%{opacity:1}25%,75%{opacity:0}}
.controls{padding:10px;background:#fff;display:flex;flex-direction:column;gap:4px}
textarea{width:100%;font-size:16px;resize:none}
input[type=range]{width:100%}
.menu{display:flex;gap:4px;margin:4px 0}
.menu button{flex:1;padding:6px;font-size:14px}
.copyBtn, .quoteBtn{position:absolute;top:4px;right:4px;margin-left:4px;font-size:12px;padding:2px 4px;cursor:pointer}
img.gen{max-width:70%;border-radius:10px;margin-top:4px}
</style>
</head>
<body>

<div class="menu">
 <button onclick="setPersona('joker')">ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
 <button onclick="setPersona('harley')">ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
 <button onclick="newThread()">â•æ–°ã‚¹ãƒ¬ãƒƒãƒ‰</button>
</div>

<div id="threadList"></div>

<div class="chat" id="chat"></div>

<div class="controls">
 <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
 <div>æ¯’èˆŒåº¦: <input type="range" id="toxic" min="0" max="100"></div>
 <div>ç‹‚æ°—åº¦: <input type="range" id="mad" min="0" max="100"></div>
 <input type="file" id="img" accept="image/*">
 <button onclick="send()">é€ä¿¡</button>
 <button onclick="genImage()">ğŸ¨ ç”»åƒç”Ÿæˆ</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const toxic=document.getElementById("toxic");
const mad=document.getElementById("mad");
const imgInput=document.getElementById("img");
const threadList=document.getElementById("threadList");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR")||null;

if(!threads.length) newThread();
else loadThread(cur);

function save(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR",cur);}
function setPersona(p){const t=threads.find(x=>x.id===cur);if(!t)return;t.persona=p;save();render();}
function newThread(){const id="t"+Date.now();threads.unshift({id,title:"æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰",persona:"joker",toxic:50,mad:50,his:[]});cur=id;save();loadThread(cur);}
function loadThread(id){cur=id;const t=threads.find(x=>x.id===cur);if(!t)return;toxic.value=t.toxic;mad.value=t.mad;render();}

function renderThreads(){
 threadList.innerHTML="";
 threads.forEach(t=>{
  const div=document.createElement("div");
  div.className="thread-title";
  div.style.backgroundColor=t.persona==="joker"? "var(--joker-title)":"var(--harley-title)";
  div.textContent=t.title;
  div.onclick=()=>loadThread(t.id);
  threadList.appendChild(div);
 });
}

function render(){
 renderThreads();
 chat.innerHTML="";
 const t=threads.find(x=>x.id===cur);
 if(!t) return;
 for(let i=t.his.length-1;i>=0;i--){
  const m=t.his[i];
  const div=document.createElement("div");
  div.className=m.role==="user"?"msg user":"msg ai "+m.persona;
  const b=document.createElement("div");
  b.className="bubble";
  b.textContent=m.content;
  if(m.role==="ai" && m.typing) b.classList.add("typing");
  div.appendChild(b);
  if(m.role==="ai" && !m.img){
   const copyBtn=document.createElement("button");
   copyBtn.className="copyBtn";copyBtn.textContent="ã‚³ãƒ”ãƒ¼";copyBtn.onclick=()=>navigator.clipboard.writeText(m.content);
   const quoteBtn=document.createElement("button");quoteBtn.className="quoteBtn";quoteBtn.textContent="å¼•ç”¨";quoteBtn.onclick=()=>{ q.value="> "+m.content+"\n"+q.value; };
   div.appendChild(copyBtn);div.appendChild(quoteBtn);
  }
  if(m.img){
   const im=document.createElement("img");
   im.src=m.img;im.className="gen";div.appendChild(im);
  }
  chat.appendChild(div);
 }
 chat.scrollTop=chat.scrollHeight;
}

function systemPrompt(tox,mad,persona){
 return `
å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã®è„³å†…ğŸ§ ä¸–ç•Œã€‚
${persona==="joker"?"ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼":"ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³"}äººæ ¼å›ºå®šã€‚
ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ§ãƒ¼ã‚¯ã¨æ¯”å–©ã®ã¿ã€‚
æ¯’èˆŒåº¦:${tox}/100
ç‹‚æ°—åº¦:${mad}/100
å…·ä½“çš„æ‰‹é †ãƒ»æ•°å€¤ã¯ç¦æ­¢ã€‚
å¿…ãšã€Œãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§ã€ã‚’å«ã‚ã‚‹ã€‚
é–¢è¥¿å¼ã€‚
`;
}

q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send()}};

async function send(){
 const t=threads.find(x=>x.id===cur);
 if(!t) return;
 const text=q.value.trim(); if(!text)return;
 q.value="";
 t.toxic=toxic.value;t.mad=mad.value;
 const aiMsg={role:"ai",content:"å…¥åŠ›ä¸­â€¦",typing:true,persona:t.persona};
 t.his.push({role:"user",content:text}); t.his.push(aiMsg);
 render(); save();

 try{
  const res=await fetch(API,{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({
    model:"gpt-4o-mini",
    messages:[
     {role:"system",content:systemPrompt(t.toxic,t.mad,t.persona)},
     {role:"user",content:text}
    ]
   })
  });
  const data=await res.json();
  aiMsg.content=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
  aiMsg.typing=false;
  render();save();
 }catch(e){aiMsg.content="ã‚¨ãƒ©ãƒ¼: "+e.message;aiMsg.typing=false;render();save();}
}

async function genImage(){
 const prompt=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹"); if(!prompt)return;
 const t=threads.find(x=>x.id===cur); if(!t) return;
 const r=await fetch(API+"/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
 const d=await r.json();
 const url=d.data?.[0]?.url;
 if(url){ t.his.push({role:"ai",img:url,content:"ç”»åƒç”Ÿæˆ",persona:t.persona}); render(); save(); }
}
</script>
</body>
</html>
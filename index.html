<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
  --bg:#f7f7f8; --chat:#fff; --user:#dcf8c6; --top:#ddd;
}
.line-mode{
  --bg:#e6f0ff; --chat:#fff; --user:#cce5ff;
}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden;}
.app{display:flex;height:100%;}
.side{position:fixed;top:0;left:0;height:100%;width:240px;background:#202123;color:#fff;transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column;z-index:20;}
.side.open{transform:translateX(0);}
.side h1{margin:10px;font-size:16px;}
.side input,.side button{margin:4px;border-radius:6px;border:0;padding:6px;}
.list{flex:1;overflow:auto;}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
.item.active{background:#2a2b32;}
.main{flex:1;display:flex;flex-direction:column;margin-left:0;}
.top{padding:10px;background:var(--top);display:flex;align-items:center;justify-content:space-between;}
.chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;}
.msg{display:flex;margin:6px 0;align-items:flex-end;}
.msg.user{justify-content:flex-end;}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap;}
.msg.user .bubble{background:var(--user);}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;}
.controls{padding:10px;background:var(--top);display:flex;flex-direction:column;gap:6px;}
textarea{width:100%;font-size:16px;resize:none;}
.progress{height:4px;background:#4caf50;width:0%;transition:width .1s;}
.menuBox{display:flex;gap:4px;}
.menuBox button{flex:1;padding:6px;}
/* ç‚¹æ»… */
.blink{animation:blink 1s step-start 0s infinite;}
@keyframes blink{50%{opacity:0;}}
/* ã‚³ãƒ”ãƒ¼ãƒ»å¼•ç”¨ */
.copyBtn, .quoteBtn{margin-left:4px;padding:2px 4px;font-size:12px;cursor:pointer;}
</style>
</head>
<body>

<div class="side" id="side">
  <h1>waru GPT</h1>
  <input placeholder="æ¤œç´¢" oninput="renderThreads(this.value)">
  <button onclick="newThread()">ï¼‹ æ–°ã‚¹ãƒ¬ãƒƒãƒ‰</button>
  <div class="list" id="threads"></div>
  <button onclick="toggleUI()">LINE/GPTåˆ‡æ›¿</button>
  <button onclick="togglePersonaMenu()">ğŸ§  Personaè¨­å®š</button>
</div>

<div class="app">
  <div class="main">
    <div class="top">
      <span onclick="toggleSide()">â˜°</span>
      <b id="curThreadTitle">New Chat</b>
      <div class="progress" id="prog"></div>
    </div>
    <div class="chat" id="chat"></div>
    <div class="controls">
      <textarea id="q" rows="2" placeholder="Enterã§é€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
      <div class="menuBox">
        <button onclick="send()">é€ä¿¡</button>
        <button onclick="genImage()">ğŸ¨ ç”»åƒç”Ÿæˆ</button>
      </div>
      <div>
        æ¯’èˆŒåº¦: <input type="range" id="toxic" min="0" max="100" value="50">
        ç‹‚æ°—åº¦: <input type="range" id="mad" min="0" max="100" value="50">
      </div>
      <div id="personaMenu" style="display:none;">
        <button onclick="setPersona('joker')">ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
        <button onclick="setPersona('harley')">ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
        <button onclick="setPersona('ai')">ğŸ¤–ç„¡æ©Ÿè³ªAI</button>
      </div>
    </div>
  </div>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const prog=document.getElementById("prog");
const threadsDiv=document.getElementById("threads");
const toxicInput=document.getElementById("toxic");
const madInput=document.getElementById("mad");
let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR")||null;
let personaType="joker";
let uiMode="gpt"; // gpt / line

function toggleSide(){document.getElementById("side").classList.toggle("open");}
function toggleUI(){
  uiMode=uiMode==="gpt"?"line":"gpt";
  document.body.classList.toggle("line-mode", uiMode==="line");
}
function togglePersonaMenu(){document.getElementById("personaMenu").style.display=document.getElementById("personaMenu").style.display==="none"?"block":"none";}
function setPersona(p){personaType=p;renderThreads();}

function save(){localStorage.setItem("THREADS",JSON.stringify(threads)); localStorage.setItem("CUR",cur);}
function newThread(){
  const id="t"+Date.now();
  threads.unshift({id,title:"New Chat",persona:personaType,sliders:{toxic:50,mad:50},history:[]});
  cur=id;save();renderThreads();renderChat();
}
function renderThreads(filter=""){
  threadsDiv.innerHTML="";
  threads.filter(t=>t.title.includes(filter)).forEach(t=>{
    const d=document.createElement("div");
    d.className="item"+(t.id===cur?" active":"");
    d.innerHTML=`<span>${t.title}</span><span>â€¦</span>`;
    d.querySelector("span:last-child").onclick=e=>{e.stopPropagation();deleteThread(t.id);}
    d.onclick=()=>{cur=t.id;renderThreads();renderChat();}
    threadsDiv.appendChild(d);
  });
}
function deleteThread(id){threads=threads.filter(t=>t.id!==id); if(cur===id)cur=threads[0]?.id||null;save();renderThreads();renderChat();}
function renderChat(){
  chat.innerHTML="";
  const t=threads.find(x=>x.id===cur); if(!t) return;
  document.getElementById("curThreadTitle").textContent=t.title;
  t.history.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg "+m.role;
    const b=document.createElement("div"); b.className="bubble"; b.textContent=m.content;
    div.appendChild(b);
    const copyBtn=document.createElement("button"); copyBtn.textContent="ğŸ“‹"; copyBtn.className="copyBtn"; copyBtn.onclick=()=>navigator.clipboard.writeText(m.content);
    const quoteBtn=document.createElement("button"); quoteBtn.textContent="â"; quoteBtn.className="quoteBtn"; quoteBtn.onclick=()=>{q.value=m.content; q.focus();}
    div.appendChild(copyBtn); div.appendChild(quoteBtn);
    chat.appendChild(div);
  });
  chat.scrollTop=1e9;
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åæ˜ 
  toxicInput.value=t.sliders.toxic;
  madInput.value=t.sliders.mad;
}

q.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}});

async function send(){
  const t=threads.find(x=>x.id===cur); if(!t) return;
  const text=q.value.trim(); if(!text) return;
  q.value="";
  t.history.push({role:"user",content:text});
  t.history.push({role:"ai",content:"å…¥åŠ›ä¸­â€¦"});
  renderChat();
  prog.style.width="10%";

  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        type:"chat",
        messages:[{content:text}],
        persona:t.persona,
        sliders:t.sliders
      })
    });
    const data=await res.json();
    t.history.pop();
    const ans=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
    t.history.push({role:"ai",content:ans});
    save(); renderChat(); prog.style.width="100%";
    setTimeout(()=>{prog.style.width="0%";},500);
  }catch(e){ t.history.pop(); t.history.push({role:"ai",content:"ã‚¨ãƒ©ãƒ¼:"+e.message}); renderChat(); prog.style.width="0%";}
  // æ°¸ç¶šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
  t.sliders.toxic=toxicInput.value;
  t.sliders.mad=madInput.value;
  save();
}

async function genImage(){
  const p=prompt("ç”Ÿæˆã—ãŸã„ç”»åƒã®å†…å®¹");
  if(!p) return;
  const t=threads.find(x=>x.id===cur); if(!t) return;
  const res=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({type:"image",prompt:p})
  });
  const data=await res.json();
  const url=data.data?.[0]?.url;
  if(url) t.history.push({role:"ai",content:url}); save(); renderChat();
}

// åˆæœŸåŒ–
if(!threads.length) newThread(); else { if(!cur) cur=threads[0].id; renderThreads(); renderChat();}
</script>

</body>
</html>
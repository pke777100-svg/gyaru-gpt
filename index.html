<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
  --bg:#f7f7f8; --side:#202123; --chat:#fff; --user:#dcf8c6; --primary:#4a90e2;
}
body.dark{
  --bg:#1e1e1e; --chat:#2c2c2c; --user:#3f7d4f; --primary:#1a73e8;
}
body{margin:0;font-family:-apple-system; background:var(--bg);height:100vh;overflow:hidden}
.app{display:flex;height:100%}

/* sidebar */
.side{position:fixed;top:0;left:0;height:100%;width:260px;background:var(--side);color:#fff;z-index:20;transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column;}
.side.open{transform:translateX(0);}
.side h1{font-size:16px;margin:10px;}
.side input,.side button{margin:6px;border-radius:6px;border:0;padding:8px;}
.list{flex:1;overflow:auto;}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer;}
.item.active{background:#2a2b32;}
.item span.title{flex:1;}
.more{padding:4px 8px;font-size:20px;color:#aaa;cursor:pointer;}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10;}
.overlay.show{display:block;}

/* main */
.main{flex:1;display:flex;flex-direction:column;}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;align-items:center;}
.chat{flex:1;overflow:auto;padding:12px;}
.msg{display:flex;margin:8px 0;align-items:flex-end;}
.msg.user{justify-content:flex-end;}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap;}
.msg.user .bubble{background:var(--user);}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;display:flex;flex-direction:column;gap:4px;}
textarea{width:100%;font-size:16px;resize:none;}
.gen{max-width:70%;border-radius:10px;}

/* buttons */
.settings{margin-left:auto;cursor:pointer;}
.blink{animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.2;}}

/* theme switch */
.theme-btn{padding:6px 8px;border-radius:4px;border:0;cursor:pointer;background:var(--primary);color:#fff;margin:0 2px;}
</style>
</head>
<body>

<div class="overlay" id="ov" onclick="toggleSide(false)"></div>

<!-- sidebar -->
<div class="side" id="side">
  <h1>waru GPT âš™ï¸</h1>
  <input placeholder="æ¤œç´¢" oninput="renderThreads(this.value)">
  <button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
  <button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
  <button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
  <div class="list" id="threads"></div>
  <button onclick="toggleTheme()">ğŸ¨ ãƒ†ãƒ¼ãƒåˆ‡æ›¿</button>
</div>

<div class="app">
  <div class="main">
    <div class="top">
      <span onclick="toggleSide()">â˜°</span><b id="threadTitle">New Chat</b>
      <span class="settings" onclick="openSettings()">âš™ï¸</span>
    </div>
    <div class="chat" id="chat"></div>
    <div class="controls">
      <input type="file" id="img" accept="image/*">
      <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
      <div style="display:flex;gap:4px;margin-top:4px;">
        <button onclick="sendMessage()">é€ä¿¡</button>
        <button onclick="generateImage()">ğŸ¨ç”»åƒç”Ÿæˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const threadsDiv=document.getElementById("threads");
let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let curThread=localStorage.getItem("CUR_THREAD")||null;
let curPersona="joker";
let threadSettings={};

// UI functions
function toggleSide(show){document.getElementById("side").classList.toggle("open",show);document.getElementById("ov").classList.toggle("show",show);}
function toggleTheme(){document.body.classList.toggle("dark");}
function openSettings(){alert("ã“ã“ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã®æ¯’èˆŒåº¦ãƒ»ç‹‚æ°—åº¦ãƒ»éŸ³å£°èª­ã¿ä¸Šã’ãªã©è¨­å®šå¯èƒ½");}

// Thread functions
function newThread(persona){
  const id="t"+Date.now();
  const t={id,title:"New Chat",persona,history:[],settings:{toxic:50,mad:50,voice:false}};
  threads.unshift(t); curThread=id; saveThreads(); renderThreads(); renderChat();
}
function renderThreads(filter=""){
  threadsDiv.innerHTML="";
  threads.filter(t=>t.title.includes(filter)).forEach(t=>{
    const d=document.createElement("div");
    d.className="item"+(t.id===curThread?" active":"");
    d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
    d.onclick=()=>{curThread=t.id;renderChat();renderThreads();}
    d.querySelector(".more").onclick=e=>{e.stopPropagation();openSettings();}
    threadsDiv.appendChild(d);
  });
}
function saveThreads(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR_THREAD",curThread);}

// Chat functions
function renderChat(){
  chat.innerHTML="";
  if(!curThread) return;
  const t=threads.find(x=>x.id===curThread);
  document.getElementById("threadTitle").textContent=t.title;
  t.history.forEach(m=>{
    if(m.type==="img"){chat.innerHTML+=`<div class="msg ai"><img class="gen" src="${m.url}"></div>`;}
    else{chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}</div></div>`;}
  });
  chat.scrollTop=1e9;
}

// Send message
q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}};
async function sendMessage(){
  if(!curThread) return;
  const t=threads.find(x=>x.id===curThread);
  const text=q.value.trim(); if(!text) return;
  q.value="";
  t.history.push({role:"user",content:text});
  const aiDiv=document.createElement("div"); aiDiv.className="msg ai"; aiDiv.innerHTML=`<div class="bubble blink">å…¥åŠ›ä¸­â€¦</div>`; chat.appendChild(aiDiv); chat.scrollTop=1e9;

  // Call API
  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:[
          {role:"system",content:`å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚äººæ ¼:${t.persona}ã€‚æ¯’èˆŒåº¦:${t.settings.toxic}/100 ç‹‚æ°—åº¦:${t.settings.mad}/100`},
          {role:"user",content:text}
        ]
      })
    });
    const data=await res.json();
    const ans=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
    t.history.push({role:"assistant",content:ans});
    renderChat();
    saveThreads();
    // Voice read
    if(t.settings.voice){const utter=new SpeechSynthesisUtterance(ans);speechSynthesis.speak(utter);}
  }catch(e){aiDiv.innerHTML=`<div class="bubble">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;}
}

// Image generation
async function generateImage(){
  if(!curThread) return;
  const t=threads.find(x=>x.id===curThread);
  const p=prompt("ç”Ÿæˆã—ãŸã„ç”»åƒã®å†…å®¹"); if(!p) return;
  try{
    const r=await fetch(API+"/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:p})});
    const d=await r.json();
    const url=d.data?.[0]?.url;
    t.history.push({type:"img",url});
    renderChat(); saveThreads();
  }catch(e){alert("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:"+e.message);}
}

// Init
if(!threads.length) newThread("joker"); else {renderThreads(); renderChat();}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{--bg:#f7f7f8;--chat:#fff;--user:#dcf8c6;--joker:#ffe0e0;--harley:#ffeaff;--ai:#e0e0ff;--input:#fff}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden}
.app{display:flex;height:100%}
.side{position:fixed;top:0;left:0;height:100%;width:260px;background:#202123;color:#fff;z-index:20;transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column}
.side.open{transform:translateX(0)}
.side h1{font-size:14px;margin:10px}
.side input,.side button{margin:6px;border-radius:6px;border:0;padding:8px}
.list{flex:1;overflow:auto}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer}
.item.active{background:#2a2b32}
.more{padding:4px 8px;font-size:20px;color:#aaa}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10}
.overlay.show{display:block}
.main{flex:1;display:flex;flex-direction:column;margin-left:0}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;align-items:center;position:sticky;top:0;z-index:5}
.chat{flex:1;overflow:auto;padding:12px}
.msg{display:flex;margin:8px 0}
.msg.user{justify-content:flex-end}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap}
.msg.user .bubble{background:var(--user)}
.msg.ai.joker .bubble{background:var(--joker)}
.msg.ai.harley .bubble{background:var(--harley)}
.msg.ai.ai .bubble{background:var(--ai)}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;display:flex;gap:4px;align-items:center}
textarea{flex:1;font-size:16px;padding:6px;border-radius:6px;border:1px solid #ccc}
button{padding:8px 12px;border-radius:6px;border:none;background:#4caf50;color:#fff;cursor:pointer}
.progress{height:4px;background:#4caf50;width:0;transition:width .1s}
.menuBox{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:12px 12px 0 0;display:none;z-index:30;padding:10px}
.menuBox button{width:100%;padding:12px;margin:6px 0;font-size:16px}
.blink{animation:blink 1s infinite;color:blue;font-weight:bold}
@keyframes blink{0%,50%,100%{opacity:1}25%,75%{opacity:0}}
</style>
</head>
<body>
<div class="overlay" id="ov" onclick="toggleSide(false);closeMenu()"></div>

<div class="side" id="side">
<h1>waru GPT</h1>
<input placeholder="æ¤œç´¢" oninput="render(this.value)">
<button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
<button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
<button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
<div class="list" id="threads"></div>
<button onclick="share()">ğŸ”— å…±æœ‰URL</button>
<button onclick="toggleUI()">ğŸ’¡ LINE/GPTåˆ‡æ›¿</button>
</div>

<div class="app">
<div class="main">
<div class="top">
<span onclick="toggleSide()">â˜°</span><b id="currentTitle">Chat</b>
</div>
<div class="chat" id="chat"></div>
<div class="progress" id="prog"></div>
<div class="controls">
<textarea id="q" rows="2" placeholder="Enterã§é€ä¿¡ / Shift+Enterã§æ”¹è¡Œ"></textarea>
<button onclick="send()">é€ä¿¡</button>
<button onclick="copyText()">â€¦</button>
</div>
</div>
</div>

<div class="menuBox" id="menu">
<button onclick="renameThread()">âœï¸ åå‰å¤‰æ›´</button>
<button onclick="deleteThread()">ğŸ—‘ å‰Šé™¤</button>
<button onclick="closeMenu()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const side=document.getElementById("side");
const ov=document.getElementById("ov");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const menu=document.getElementById("menu");
const prog=document.getElementById("prog");
const currentTitle=document.getElementById("currentTitle");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR")||null;
let menuId=null;
let currentPersona="joker";

function toggleSide(v){const o=v!==undefined?v:!side.classList.contains("open");side.classList.toggle("open",o);ov.classList.toggle("show",o);}
function toggleUI(){document.body.classList.toggle("line");}

function save(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR",cur);}

function newThread(p){
 const id="t"+Date.now();
 threads.unshift({id,title:"New chat",p,his:[],slider:50});
 cur=id; currentPersona=p; save(); render(); toggleSide(false);
}

function openMenu(e,id){e.stopPropagation();menuId=id;menu.style.display="block";ov.classList.add("show");}
function closeMenu(){menu.style.display="none";menuId=null;ov.classList.remove("show");}
function renameThread(){const t=threads.find(x=>x.id===menuId); if(!t)return; const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title); if(n){t.title=n;save();render();} closeMenu();}
function deleteThread(){threads=threads.filter(x=>x.id!==menuId); if(cur===menuId)cur=threads[0]?.id||null; save();render();closeMenu();}

function render(f=""){
 threadsDiv.innerHTML="";
 threads.filter(t=>t.title.includes(f)).forEach(t=>{
  const d=document.createElement("div");
  d.className="item"+(t.id===cur?" active":"");
  d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
  d.onclick=()=>{cur=t.id;currentPersona=threads.find(x=>x.id===cur).p;save();render();toggleSide(false)};
  d.querySelector(".more").onclick=e=>openMenu(e,t.id);
  threadsDiv.appendChild(d);
 });
 chat.innerHTML="";
 const t=threads.find(x=>x.id===cur); if(!t)return;
 currentTitle.textContent=t.title;
 t.his.forEach(m=>{
  const div=document.createElement("div");
  div.className="msg "+m.role+(m.role==="ai"?" "+(m.p||t.p):"");
  div.innerHTML=`<div class="bubble">${m.content}</div>`;
  chat.appendChild(div);
 });
 chat.scrollTop=1e9;
}

q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}};

function addMsg(role,content,p=null){const div=document.createElement("div");div.className="msg "+role+(p?" "+p:""); div.innerHTML=`<div class="bubble">${content}</div>`; chat.appendChild(div);chat.scrollTop=1e9; return div;}

async function send(){
 const t=threads.find(x=>x.id===cur); if(!t)return;
 const text=q.value.trim(); if(!text)return;
 q.value="";
 const aiDiv=addMsg("ai","å…¥åŠ›ä¸­â€¦",t.p);
 aiDiv.classList.add("blink");
 prog.style.width="0%";
 let progress=0;
 const interval=setInterval(()=>{progress+=5;if(progress>95)progress=95;prog.style.width=progress+"%";},100);
 try{
  const res=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:text}],persona:t.p,slider:t.slider})});
  const data=await res.json();
  clearInterval(interval);prog.style.width="100%";
  const ans=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
  aiDiv.classList.remove("blink");
  aiDiv.innerHTML=`<div class="bubble">${ans}</div>`;
  t.his.push({role:"user",content:text}); t.his.push({role:"ai",content:ans,p:t.p});
  save();render(); setTimeout(()=>{prog.style.width="0%";},500);
 }catch(e){clearInterval(interval);aiDiv.innerHTML=`<div class="bubble">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;prog.style.width="0%";}
}

function copyText(){navigator.clipboard.writeText(q.value);alert("ã‚³ãƒ”ãƒ¼ã—ãŸã§");}

function share(){const t=threads.find(x=>x.id===cur); if(!t)return; location.hash=btoa(encodeURIComponent(JSON.stringify(t))); alert("URLã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãª");}
if(location.hash.length>1){try{const t=JSON.parse(decodeURIComponent(atob(location.hash.slice(1))));threads=[t];cur=t.id;save();}catch(e){}}

if(!threads.length)newThread("joker"); else render();
</script>
</body>
</html>
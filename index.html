<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Charisma GPT</title>
<style>
:root{
  --joker-bg:#0b0214;--harley-bg:#14020a;--third-bg:#1a1a0b;
  --joker-accent:#7c3aed;--harley-accent:#ec4899;--third-accent:#facc15;
}
body{margin:0;font-family:-apple-system;background:var(--joker-bg);color:#e5e7eb;transition:background .3s}
#top{display:flex;gap:8px;padding:10px;overflow-x:auto;position:sticky;top:0;background:#000;z-index:10}
.personaBtn{flex:0 0 auto;padding:10px 14px;border:none;border-radius:16px;color:#fff;font-weight:600;cursor:pointer}
#jokerBtn{background:var(--joker-accent)}
#harleyBtn{background:var(--harley-accent)}
#thirdBtn{background:var(--third-accent);display:none}
#chat{padding:12px;height:calc(100vh - 220px);overflow:auto}
.bubble{max-width:78%;padding:12px 14px;border-radius:18px;margin-bottom:10px;word-break:break-word}
.user{margin-left:auto;background:#2563eb}
.ai{background:#1f2937}
#thinking{padding:6px 12px;margin:6px;border-radius:14px;font-size:12px;background:#222;overflow:hidden;height:24px}
footer{display:flex;padding:10px;border-top:1px solid #1e293b;position:sticky;bottom:0;background:#000;z-index:10}
input{flex:1;padding:12px;border-radius:16px;border:none;font-size:16px}
button.send{width:42px;margin-left:6px;border:none;border-radius:50%;font-size:18px;cursor:pointer}
#psychTest{display:none;padding:10px}
canvas{width:100%;height:150px}
</style>
</head>
<body>

<div id="top">
  <button id="jokerBtn" class="personaBtn">üÉè Joker</button>
  <button id="harleyBtn" class="personaBtn">üíã Harley</button>
  <button id="thirdBtn" class="personaBtn">‚ö° Evil Council</button>
</div>

<div id="chat"></div>
<div id="thinking">ü§ñ</div>
<div id="psychTest"><canvas id="psychCanvas"></canvas></div>

<footer>
  <input id="input" placeholder="Message‚Ä¶" />
  <button class="send" onclick="send()">‚Üë</button>
</footer>

<script>
const WORKER_URL="https://frosty-shadow-3411.pke777100.workers.dev";
let persona=localStorage.getItem("persona")||"joker";
let memory=JSON.parse(localStorage.getItem("charismaMemory")||"[]");
let score=Number(localStorage.getItem("charismaScore")||0);

applyPersona();
checkThirdBtn();

jokerBtn.onclick=()=>switchPersona("joker");
harleyBtn.onclick=()=>switchPersona("harley");
thirdBtn.onclick=()=>switchPersona("third");

function switchPersona(p){
  persona=p;
  localStorage.setItem("persona",p);
  applyPersona();
}

function applyPersona(){
  if(persona==="joker") document.body.style.background="var(--joker-bg)";
  else if(persona==="harley") document.body.style.background="var(--harley-bg)";
  else document.body.style.background="var(--third-bg)";
}

function checkThirdBtn(){if(score>=10) thirdBtn.style.display="inline-block"}

const randomPhrases=new Array(1000).fill(0).map((_,i)=>`Random phrase ${i+1}`);
function showRandomPhrase(){
  const phrase=randomPhrases[Math.floor(Math.random()*randomPhrases.length)];
  add(phrase,"ai");
}

function add(text,cls){const d=document.createElement("div");d.className="bubble "+cls;d.textContent=text;chat.appendChild(d);chat.scrollTop=chat.scrollHeight}

function thinkingEffect(){
  const thinking=document.getElementById("thinking");
  thinking.style.display="block";
  let chars="‚äó‚äï‚ñ¢‚ñ£‚óá‚óÜ‚ñ†‚ñ°‚óº";
  let interval=setInterval(()=>{thinking.textContent=chars[Math.floor(Math.random()*chars.length)]},50);
  return interval;
}

async function send(){
  const text=input.value.trim();
  if(!text)return;
  input.value="";
  add(text,"user");
  memory.push({role:"user",content:text});
  save();

  showRandomPhrase();

  const interval=thinkingEffect();

  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({persona,messages:memory})
    });
    const data=await res.json();
    clearInterval(interval);
    document.getElementById("thinking").style.display="none";
    add(data.reply,"ai");
    memory.push({role:"assistant",content:data.reply});
    score++;
    save();
    checkThirdBtn();
    if(score>=20) showPsychTest();
  }catch{
    clearInterval(interval);
    document.getElementById("thinking").style.display="none";
    add("‚Ä¶ÈÄö‰ø°„Ç®„É©„Éº„ÄÇÂÜçË©¶Ë°å„Åõ„Çà„ÄÇ","ai");
  }
}

function save(){
  localStorage.setItem("charismaMemory",JSON.stringify(memory));
  localStorage.setItem("charismaScore",score);
  localStorage.setItem("persona",persona);
}

function showPsychTest(){
  const canvas=document.getElementById("psychCanvas");
  document.getElementById("psychTest").style.display="block";
  const ctx=canvas.getContext("2d");
  const size=canvas.width/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const segments=[score%100,(100-score%100)];
  let start=0;
  segments.forEach((v,i)=>{
    ctx.beginPath();
    ctx.moveTo(size,75);
    ctx.arc(size,75,70,start,start+2*Math.PI*(v/100));
    ctx.fillStyle=i===0?"#7c3aed":"#ec4899";
    ctx.fill();
    start+=2*Math.PI*(v/100);
  });
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>KawaiiGPT å®Œå…¨ç‰ˆ 1ãƒ•ã‚¡ã‚¤ãƒ«</title>
<style>
:root{--bg:#f7f7f8;--side:#202123;--chat:#fff;--user:#dcf8c6;}
.dark{--bg:#343541;--chat:#444654;--user:#2f7d4f;}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden;}
.app{display:flex;height:100%;}
.side{position:fixed;top:0;left:0;height:100%;width:260px;background:var(--side);color:#fff;z-index:20;transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column;}
.side.open{transform:translateX(0);}
.side h1{font-size:14px;margin:10px;}
.side input,.side button{margin:6px;border-radius:6px;border:0;padding:8px;}
.list{flex:1;overflow:auto;}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer;}
.item.active{background:#2a2b32;}
.item span.title{flex:1;}
.more{padding:4px 8px;font-size:20px;color:#aaa;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10;}
.overlay.show{display:block;}
.main{flex:1;display:flex;flex-direction:column;}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;align-items:center;}
.chat{flex:1;overflow:auto;padding:12px;}
.msg{margin:8px 0;}
.msg.user{text-align:right;}
.bubble{display:inline-block;padding:10px;border-radius:10px;white-space:pre-wrap;}
.msg.user .bubble{background:var(--user);}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;}
textarea{width:100%;font-size:16px;}
#spinner{display:none;width:24px;height:24px;border:4px solid #ccc;border-top-color:#007bff;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px;vertical-align:middle;}
@keyframes spin{100%{transform:rotate(360deg);}}
#progressContainer{width:100%;height:18px;background:#eee;border-radius:9px;margin-top:6px;}
#progressBar{width:0%;height:100%;background:#007bff;color:#fff;text-align:center;line-height:18px;font-size:12px;}
img.gen{max-width:70%;border-radius:10px;}
.menuBox{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:12px 12px 0 0;display:none;z-index:30;padding:10px;}
.menuBox button{width:100%;padding:12px;margin:6px 0;font-size:16px;}
</style>
</head>
<body>

<div class="overlay" id="ov" onclick="toggleSide(false);closeMenu()"></div>
<div class="side" id="side">
 <h1>KawaiiGPT</h1>
 <input placeholder="æ¤œç´¢" oninput="render(this.value)">
 <button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
 <button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
 <button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
 <div class="list" id="threads"></div>
 <button onclick="dark()">ğŸŒ™ Dark</button>
</div>

<div class="app">
 <div class="main">
  <div class="top">
   <span onclick="toggleSide()">â˜°</span><b>Chat</b>
   <span id="spinner"></span>
  </div>
  <div class="chat" id="chat"></div>
  <div class="controls">
   <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea><br>
   <button onclick="send()">é€ä¿¡</button>
   <button onclick="gen()">ğŸ¨ ç”»åƒç”Ÿæˆ</button>
   <div id="progressContainer"><div id="progressBar">0%</div></div>
  </div>
 </div>
</div>

<div class="menuBox" id="menu">
 <button onclick="renameThread()">âœï¸ åå‰å¤‰æ›´</button>
 <button onclick="deleteThread()">ğŸ—‘ å‰Šé™¤</button>
 <button onclick="closeMenu()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
const side=document.getElementById("side");
const ov=document.getElementById("ov");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const spinner=document.getElementById("spinner");
const progressBar=document.getElementById("progressBar");
const menu=document.getElementById("menu");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR");
let menuId=null;
const API="https://lingering-tree-bd40.pke777100.workers.dev"; // ãƒ‡ãƒ—ãƒ­ã‚¤ URL

function toggleSide(v){const o=v!==undefined?v:!side.classList.contains("open"); side.classList.toggle("open",o); ov.classList.toggle("show",o);}
function dark(){document.body.classList.toggle("dark"); localStorage.setItem("DARK",document.body.classList.contains("dark"));}
if(localStorage.getItem("DARK")==="true")document.body.classList.add("dark");
function save(){ localStorage.setItem("THREADS",JSON.stringify(threads)); localStorage.setItem("CUR",cur); }

function newThread(p){ const id="t"+Date.now(); threads.unshift({id,title:"New chat",p,his:[]}); cur=id; save(); render(); toggleSide(false); }
function openMenu(e,id){ e.stopPropagation(); menuId=id; menu.style.display="block"; ov.classList.add("show"); }
function closeMenu(){ menu.style.display="none"; menuId=null; ov.classList.remove("show"); }
function renameThread(){ const t=threads.find(x=>x.id===menuId); if(!t)return; const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title); if(n){t.title=n; save(); render();} closeMenu(); }
function deleteThread(){ threads=threads.filter(x=>x.id!==menuId); if(cur===menuId) cur=threads[0]?.id||null; save(); render(); closeMenu(); }

function render(f=""){
 threadsDiv.innerHTML="";
 threads.filter(t=>t.title.includes(f)).forEach(t=>{
  const d=document.createElement("div");
  d.className="item"+(t.id===cur?" active":"");
  d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
  d.onclick=()=>{cur=t.id; save(); render(); toggleSide(false);}
  d.querySelector(".more").onclick=e=>openMenu(e,t.id);
  threadsDiv.appendChild(d);
 });
 chat.innerHTML="";
 const t=threads.find(x=>x.id===cur); if(!t) return;
 t.his.forEach(m=>{
  if(m.type==="img"){ chat.innerHTML+=`<div class="msg ai"><img class="gen" src="${m.url}"></div>`; }
  else chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}</div></div>`;
 });
 chat.scrollTop=1e9;
}

function persona(p){
 if(p==="joker") return "é–¢è¥¿å¼ã®ãƒ©ã‚¹ãƒœã‚¹ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã€‚çš®è‚‰ã¨ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ§ãƒ¼ã‚¯ã€‚";
 if(p==="harley") return "é–¢è¥¿å¼ã®ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³ã€‚ç‹‚æ°—ã¨æŒ‘ç™ºã€‚";
 return "ç„¡æ©Ÿè³ªã§ç°¡æ½”ã€‚";
}

function updateProgress(value){ progressBar.style.width=value+'%'; progressBar.textContent=value+'%'; }
function startFakeProgress(){let progress=0;return setInterval(()=>{if(progress<90){progress+=Math.floor(Math.random()*5)+2;if(progress>90)progress=90;updateProgress(progress);}},150); }

q.addEventListener("keydown",e=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); send(); } });

async function send(){
 const t=threads.find(x=>x.id===cur); if(!t)return;
 const text=q.value.trim(); if(!text)return; q.value="";
 t.his.push({role:"user",content:text});
 t.his.push({role:"assistant",content:"è€ƒãˆä¸­â€¦â€¦ğŸ§ "});
 render();

 spinner.style.display="inline-block"; updateProgress(0);
 const interval=startFakeProgress();

 try{
  const r=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({type:"chat",payload:{model:"gpt-4o-mini",messages:[{role:"system",content:persona(t.p)},{role:"user",content:text}]}})
  });
  const d=await r.json().catch(()=>({error:"Invalid JSON"}));
  t.his.pop();
  const ans=d.choices?.[0]?.message?.content||("ã‚¨ãƒ©ãƒ¼: "+(d.error||"ä¸æ˜"));
  t.his.push({role:"assistant",content:ans});
  updateProgress(100);
 }catch(err){
  t.his.pop(); t.his.push({role:"assistant",content:"ã‚¨ãƒ©ãƒ¼: "+err.message});
  updateProgress(100);
 }finally{
  spinner.style.display="none"; clearInterval(interval);
  if(t.title==="New chat") t.title=t.his[t.his.length-1].content.replace(/\n/g," ").slice(0,18);
  save(); render();
 }
}

async function gen(){
 const t=threads.find(x=>x.id===cur); if(!t)return;
 const promptText = prompt("ç”Ÿæˆã—ãŸã„å†…å®¹"); if(!promptText) return;
 spinner.style.display="inline-block"; updateProgress(0);
 const interval=startFakeProgress();

 try{
  const r=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({type:"image",payload:{prompt:promptText,n:1,size:"1024x1024"}})
  });
  const d=await r.json().catch(()=>({error:"Invalid JSON"}));
  const url=d.data?.[0]?.url;
  if(url) t.his.push({type:"img",url});
  else alert("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: "+(d.error||"ä¸æ˜"));
  updateProgress(100);
 }catch(err){
  alert("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: "+err.message);
  updateProgress(100);
 }finally{
  spinner.style.display="none"; clearInterval(interval); save(); render();
 }
}

if(!threads.length)newThread("joker"); else render();
</script>
</body>
</html>
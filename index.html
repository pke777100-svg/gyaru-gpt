<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
  --bg:#f7f7f8; --chat:#fff; --user:#dcf8c6; --joker:#ffe6e6; --harley:#ffe0f0;
}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100svh;overflow:hidden;}
.app{display:flex;height:100%;}
.side{
  position:fixed;top:0;left:0;width:260px;height:100%;
  background:#202123;color:#fff;z-index:20;
  transform:translateX(-100%);transition:.25s;display:flex;flex-direction:column;
}
.side.open{transform:translateX(0);}
.side h1{font-size:14px;margin:10px;}
.side input,.side button{margin:6px;border-radius:6px;border:0;padding:8px;}
.list{flex:1;overflow:auto;}
.item{padding:10px;border-bottom:1px solid #2a2b32;display:flex;align-items:center;gap:6px;cursor:pointer;}
.item.active{background:#2a2b32;}
.item span.title{flex:1;}
.more{padding:4px 8px;font-size:20px;color:#aaa;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10;}
.overlay.show{display:block;}
.main{flex:1;display:flex;flex-direction:column;}
.top{padding:10px;background:var(--chat);border-bottom:1px solid #ddd;display:flex;gap:10px;}
.chat{flex:1;overflow:auto;padding:12px;}
.msg{display:flex;margin:8px 0;}
.msg.user{justify-content:flex-end;}
.bubble{max-width:70%;padding:10px;border-radius:10px;white-space:pre-wrap;}
.msg.user .bubble{background:var(--user);}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;}
.controls{padding:10px;background:var(--chat);border-top:1px solid #ddd;display:flex;flex-direction:column;}
.controls textarea{width:100%;font-size:16px;margin-bottom:6px;}
img.gen{max-width:70%;border-radius:10px;}
.menuBox{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:12px 12px 0 0;display:none;z-index:30;padding:10px;}
.menuBox button{width:100%;padding:12px;margin:6px 0;font-size:16px;}
.sliderBox{display:flex;gap:4px;margin:4px 0;align-items:center;}
.sliderBox input{flex:1;}
.longPressMenu{position:absolute;background:#fff;border:1px solid #ccc;border-radius:6px;padding:6px;display:none;z-index:50;}
.longPressMenu button{display:block;width:100%;margin:2px 0;}
</style>
</head>
<body>
<div class="overlay" id="ov" onclick="toggleSide(false);closeMenu()"></div>
<div class="side" id="side">
  <h1>waru GPT</h1>
  <input placeholder="æ¤œç´¢" oninput="render(this.value)">
  <button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
  <button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
  <button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
  <div class="list" id="threads"></div>
  <button onclick="share()">ğŸ”— å…±æœ‰URL</button>
</div>
<div class="app">
  <div class="main">
    <div class="top"><span onclick="toggleSide()">â˜°</span><b>Chat</b></div>
    <div class="chat" id="chat"></div>
    <div class="controls">
      <div class="sliderBox">
        <label>æ¯’èˆŒåº¦</label>
        <input type="range" id="toxic" min="0" max="100" value="50">
      </div>
      <div class="sliderBox">
        <label>ç‹‚æ°—åº¦</label>
        <input type="range" id="mad" min="0" max="100" value="50">
      </div>
      <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
      <div style="display:flex;gap:4px;">
        <button onclick="send()">é€ä¿¡</button>
        <button onclick="gen()">ğŸ¨ç”»åƒç”Ÿæˆ</button>
      </div>
    </div>
  </div>
</div>
<div class="menuBox" id="menu">
  <button onclick="renameThread()">âœï¸ åå‰å¤‰æ›´</button>
  <button onclick="deleteThread()">ğŸ—‘ å‰Šé™¤</button>
  <button onclick="closeMenu()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const side=document.getElementById("side");
const ov=document.getElementById("ov");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const menu=document.getElementById("menu");
const toxic=document.getElementById("toxic");
const mad=document.getElementById("mad");
let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR");
let menuId=null;

/* UI */
function toggleSide(v){
 const o=v!==undefined?v:!side.classList.contains("open");
 side.classList.toggle("open",o); ov.classList.toggle("show",o);
}

/* Data */
function save(){localStorage.setItem("THREADS",JSON.stringify(threads)); localStorage.setItem("CUR",cur);}

/* Threads */
function newThread(p){
  const id="t"+Date.now();
  threads.unshift({id,title:"New chat",p,his:[],toxic:50,mad:50});
  cur=id;save();render();toggleSide(false);
}
function openMenu(e,id){e.stopPropagation(); menuId=id; menu.style.display="block"; ov.classList.add("show");}
function closeMenu(){menu.style.display="none"; menuId=null; ov.classList.remove("show");}
function renameThread(){const t=threads.find(x=>x.id===menuId); if(!t)return; const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title); if(n){t.title=n;save();render();} closeMenu();}
function deleteThread(){threads=threads.filter(x=>x.id!==menuId); if(cur===menuId)cur=threads[0]?.id||null; save();render();closeMenu();}

/* Render */
function render(f=""){
 threadsDiv.innerHTML="";
 threads.filter(t=>t.title.includes(f)).forEach(t=>{
   const d=document.createElement("div");
   d.className="item"+(t.id===cur?" active":"");
   d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
   d.onclick=()=>{cur=t.id;save();render();toggleSide(false)};
   d.querySelector(".more").onclick=e=>openMenu(e,t.id);
   threadsDiv.appendChild(d);
 });
 chat.innerHTML="";
 const t=threads.find(x=>x.id===cur); if(!t)return;
 toxic.value=t.toxic; mad.value=t.mad;
 t.his.forEach(m=>{
   const div=document.createElement("div");
   div.className="msg "+m.role;
   const bubble=document.createElement("div");
   bubble.className="bubble"; bubble.textContent=m.content;
   div.appendChild(bubble);
   chat.appendChild(div);
 });
 chat.scrollTop=1e9;
}

/* Persona */
function persona(p){
 if(p==="joker") return "ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼";
 if(p==="harley") return "ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³";
 return "ğŸ¤–ç„¡æ©Ÿè³ªAI";
}

/* System Prompt */
function systemPrompt(toxicVal,madVal,p){
 return `
å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã®è„³å†…ğŸ§ ä¸–ç•Œã€‚
${persona(p)}äººæ ¼å›ºå®šã€‚
ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ§ãƒ¼ã‚¯ã¨æ¯”å–©ã®ã¿ã€‚
æ¯’èˆŒåº¦:${toxicVal}/100
ç‹‚æ°—åº¦:${madVal}/100
å…·ä½“çš„æ‰‹é †ãƒ»æ•°å€¤ç¦æ­¢
å¿…ãšã€Œãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§ã€ã‚’å«ã‚ã‚‹ã€‚
`;
}

/* Chat */
async function send(){
 const t=threads.find(x=>x.id===cur); if(!t) return;
 const text=q.value.trim(); if(!text)return; q.value="";
 t.his.push({role:"user",content:text});
 const aiDiv={role:"assistant",content:"å…¥åŠ›ä¸­â€¦"}; t.his.push(aiDiv); render();

 try{
   const res=await fetch(API,{
     method:"POST",
     headers:{"Content-Type":"application/json"},
     body:JSON.stringify({
       model:"gpt-4o-mini",
       messages:[
         {role:"system",content:systemPrompt(toxic.value,mad.value,t.p)},
         {role:"user",content:text}
       ]
     })
   });
   const data=await res.json();
   const ans=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
   aiDiv.content=ans; save(); render();
 }catch(e){aiDiv.content="ã‚¨ãƒ©ãƒ¼:"+e.message; save(); render();}
}

/* Image Gen */
async function gen(){
 const p=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹"); if(!p)return;
 const t=threads.find(x=>x.id===cur);
 try{
   const res=await fetch(API+"/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:p})});
   const data=await res.json();
   const url=data.data?.[0]?.url; if(url){t.his.push({type:"img",url}); save(); render();}
 }catch(e){alert("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: "+e.message);}
}

/* Share */
function share(){const t=threads.find(x=>x.id===cur); if(!t)return; location.hash=btoa(encodeURIComponent(JSON.stringify(t))); alert("URLã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãª");}

/* Init */
if(!threads.length)newThread("joker"); else render();
q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}};
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Charisma GPT</title>
<link rel="apple-touch-icon" href="icon.png">
<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:-apple-system;background:#000;color:#e5e7eb}
#app{height:100%;display:flex;flex-direction:column;position:relative}
#topbar{height:56px;padding:0 12px;display:flex;align-items:center;gap:10px;background:#020617;border-bottom:1px solid #1e293b}
#back{font-size:20px;cursor:pointer}
#to{flex:1;display:flex;flex-direction:column;cursor:pointer}
#to span{font-weight:600}
#to small{font-size:11px;opacity:.6}
#threads{position:fixed;inset:0;background:#020617;z-index:10;display:none;flex-direction:column}
#threads header{padding:14px;font-weight:700;border-bottom:1px solid #1e293b}
.thread{padding:14px;border-bottom:1px solid #1e293b;touch-action:none}
.thread.active{background:#1e1b4b}
#chat{flex:1;padding:12px;overflow-y:auto}
.bubble{max-width:78%;padding:12px 14px;margin-bottom:10px;border-radius:18px;line-height:1.5;word-break:break-word;}
.user{margin-left:auto;background:#2563eb;color:#fff;border-bottom-right-radius:6px}
.ai{background:#1f2937;border-bottom-left-radius:6px}
#thinking{display:none;margin:10px;padding:10px 14px;border-radius:16px;font-size:12px;background:radial-gradient(circle at center, rgba(124,58,237,.35), transparent 60%),repeating-linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.08) 2px, transparent 2px, transparent 6px);animation: drift 2s linear infinite}
@keyframes drift{from{background-position:0 0}to{background-position:-200px 0}}
footer{padding:12px;background:#020617;border-top:1px solid #1e293b;display:flex;gap:6px;align-items:center}
input{flex:1;padding:12px 14px;border-radius:18px;border:none;outline:none;font-size:16px}
input:disabled{opacity:.4}
button.sendBtn{padding:0 12px;height:40px;border-radius:50%;border:none;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;font-size:18px}
button.sendBtn:hover{background:#1e40af}
#personaSwitch{position:absolute;top:56px;left:12px;display:flex;gap:4px;z-index:20;}
#personaSwitch button{padding:6px 8px;background:#1f2937;border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;}
#personaSwitch button:hover{background:#374151;}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div id="back">â†</div>
    <div id="to">
      <span id="personaLabel">ğŸƒ Joker</span>
      <small>Charisma GPT</small>
    </div>
  </div>

  <div id="personaSwitch">
    <button data-persona="joker">ğŸƒ Joker</button>
    <button data-persona="harley">ğŸ’‹ Harley</button>
    <button data-persona="mad">ğŸ§ª MadSci</button>
  </div>

  <div id="chat"></div>
  <div id="thinking">ğŸ§  æ•µã¨å¿œæˆ¦ä¸­â€¦ æ€è€ƒãŒæ­ªã‚“ã§ã„ãâ€¦</div>
  <footer>
    <input id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â€¦" />
    <button class="sendBtn">â†‘</button>
  </footer>
</div>

<div id="threads">
  <header>ãƒãƒ£ãƒƒãƒˆ</header>
  <div id="threadList"></div>
</div>

<script>
const WORKER_URL="https://empty-night-6ba3.pke777100.workers.dev";
let threads=JSON.parse(localStorage.getItem("charismaThreads")||"{}");
let current=null;

const chat=document.getElementById("chat");
const input=document.getElementById("input");
const thinking=document.getElementById("thinking");
const threadsUI=document.getElementById("threads");
const list=document.getElementById("threadList");
const personaLabel=document.getElementById("personaLabel");
const switchUI=document.getElementById("personaSwitch");
const sendBtn=document.querySelector(".sendBtn");

function save(){localStorage.setItem("charismaThreads",JSON.stringify(threads));}
function add(text,cls){const d=document.createElement("div");d.className="bubble "+cls;d.textContent=text;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}

function newThread(persona="joker"){
  const id=Date.now().toString();
  threads[id]={
    title:"New Chat",
    persona,
    messages:[{role:"system",content: persona==="harley"?"å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚é–¢è¥¿å¼ã€‚å¥³ã®ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³ã€‚è»½ãç…½ã‚‹ã€‚":"å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã€‚é–¢è¥¿å¼ã€‚æ‚ªã®ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã€‚çš®è‚‰ã¨ãƒ–ãƒ©ãƒƒã‚¯ãƒ¦ãƒ¼ãƒ¢ã‚¢ã€‚"}]
  };
  current=id; save(); renderThreads(); renderChat();
}

function renderThreads(){
  list.innerHTML="";
  Object.keys(threads).forEach(id=>{
    const t=threads[id];
    const d=document.createElement("div");
    d.className="thread"+(id===current?" active":"");
    d.textContent=t.title;
    d.onclick=()=>{current=id;closeThreads();renderChat();}
    list.appendChild(d);
  });
  enableSwipeDelete();
}

function renderChat(){
  chat.innerHTML="";
  const t=threads[current];
  personaLabel.textContent=t.persona==="harley"?"ğŸ’‹ Harley":t.persona==="mad"?"ğŸ§ª MadSci":"ğŸƒ Joker";
  t.messages.forEach(m=>{
    if(m.role==="user") add(m.content,"user");
    if(m.role==="assistant") add(m.content,"ai");
  });
}

document.getElementById("back").onclick=()=>{threadsUI.style.display="flex";}
function closeThreads(){threadsUI.style.display="none";}

function enableSwipeDelete(){
  list.querySelectorAll(".thread").forEach(el=>{
    let startX;
    el.addEventListener("touchstart",e=>{startX=e.touches[0].clientX;});
    el.addEventListener("touchmove",e=>{
      const dx=e.touches[0].clientX-startX;
      if(dx<-50) el.style.transform=`translateX(${dx}px)`;
    });
    el.addEventListener("touchend",e=>{
      const dx=parseInt(el.style.transform.replace("translateX(",""))||0;
      if(dx<-80){
        const id=Object.keys(threads).find(k=>threads[k].title===el.textContent);
        if(id && confirm("ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¦ã„ã„ã§ã‚„ã‚“ã™ã‹ï¼Ÿ")){
          delete threads[id]; save(); renderThreads();
          if(current===id) current=Object.keys(threads)[0]||null;
          if(current) renderChat(); else chat.innerHTML="";
        }
      }
      el.style.transform="";
    });
  });
}

/* ===== ãƒœã‚¿ãƒ³å¼äººæ ¼åˆ‡æ›¿ ===== */
switchUI.querySelectorAll("button").forEach(btn=>{
  btn.onclick=()=>{
    const p=btn.dataset.persona;
    threads[current].persona=p;
    save();
    renderChat();
  };
});

/* ===== 3äººæ ¼æ‚ªå·§ã¿ä¼šè­°ï¼ˆæ™‚é–“å·®ãƒ»å®‰å…¨ãƒ»Workerå¯¾å¿œï¼‰ ===== */
async function send3Personas(){
  const text=input.value.trim();
  if(!text) return;
  input.value=""; input.disabled=true;
  add(text,"user");
  const t=threads[current];
  t.messages.push({role:"user",content:text});
  save();
  thinking.style.display="block";

  let personas=[
    {name:"Joker",sys:"æ‚ªã®ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã€‚çš®è‚‰ã¨ãƒ–ãƒ©ãƒƒã‚¯ãƒ¦ãƒ¼ãƒ¢ã‚¢ã€‚"},
    {name:"Harley",sys:"é–¢è¥¿å¼ã§è»½ãç…½ã‚‹å¥³ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³ã€‚"},
    {name:"MadSci",sys:"ç§‘å­¦ç‹‚äººã€‚è«–ç†çš„ã«å¥‡æŠœãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã™ã€‚"}
  ];

  for(let i=personas.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [personas[i],personas[j]]=[personas[j],personas[i]];
  }

  const opposerIndex=Math.floor(Math.random()*personas.length);
  let prevResponses=[];
  for(let i=0;i<personas.length;i++){
    const p=personas[i];
    let content="";
    try{
      let systemPrompt=p.sys;
      if(i===opposerIndex) systemPrompt+=" æ™‚ã€…è»½ãåå¯¾æ„è¦‹ã‚’å‡ºã™ã€‚";

      const res=await fetch(WORKER_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          messages:[
            {role:"system",content:systemPrompt},
            ...t.messages,
            ...prevResponses.map(r=>({role:"assistant",content:r}))
          ]
        })
      });

      try{
        const data=await res.json();
        if(data.choices && data.choices[0] && data.choices[0].message){
          content = data.choices[0].message.content;
        } else if(data.reply){
          content = data.reply;
        } else {
          content = "ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰";
        }
      }catch(e){
        content="ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰";
      }

      prevResponses.push(`${p.name}: ${content}`);
      t.messages.push({role:"assistant",content:`${p.name}: ${content}`});

      // æ™‚é–“å·®ã§è¡¨ç¤º
      await new Promise(r=>setTimeout(r, 700 + Math.random()*800));
      add(`${p.name}: ${content}`,"ai");

    }catch(e){
      const errMsg=`${p.name}ã§é€šä¿¡ã‚¨ãƒ©ãƒ¼`;
      prevResponses.push(errMsg);
      add(errMsg,"ai");
    }
  }

  t.title=text.slice(0,16);
  save(); renderThreads();
  thinking.style.display="none";
  input.disabled=false;
}

/* ===== é€ä¿¡æ“ä½œ ===== */
sendBtn.onclick=send3Personas;
input.addEventListener("keydown",e=>{if(e.key==="Enter") send3Personas();});

if(Object.keys(threads).length===0) newThread();
else{current=Object.keys(threads)[0];renderThreads();renderChat();}
</script>
</body>
</html>
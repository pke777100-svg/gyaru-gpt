<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root {
  --bg: #f7f7f8; --chat-bg: #fff; --user-bg: #dcf8c6;
  --ai-joker: #ffefba; --ai-harley: #ffc1c1; --ai-neutral: #e3e3e3;
}
body {margin:0;font-family:-apple-system;background:var(--bg);height:100vh;overflow:hidden;}
.app {display:flex;flex-direction:column;height:100%;}
.top-bar {display:flex;align-items:center;justify-content:space-between;padding:10px;background:#333;color:#fff;position:fixed;width:100%;z-index:10;}
.top-bar .title {font-weight:bold;}
.top-bar .settings {cursor:pointer;font-size:20px;}
.chat-container {flex:1;margin-top:50px;overflow-y:auto;padding:12px;}
.msg {display:flex;margin:6px 0;}
.msg.user {justify-content:flex-end;}
.msg.ai .bubble {border-radius:10px;padding:10px;max-width:70%;white-space:pre-wrap;}
.msg.user .bubble {background:var(--user-bg);}
.msg.ai.joker .bubble {background:var(--ai-joker);}
.msg.ai.harley .bubble {background:var(--ai-harley);}
.msg.ai.neutral .bubble {background:var(--ai-neutral);}
.controls {padding:10px;background:var(--chat-bg);display:flex;gap:6px;align-items:center;}
textarea {flex:1;font-size:16px;padding:6px;border-radius:6px;border:1px solid #ccc;resize:none;}
button {padding:8px 12px;border:none;border-radius:6px;background:#4caf50;color:#fff;cursor:pointer;}
#typing {color:blue;font-weight:bold;}
.settings-panel {position:fixed;top:50px;right:0;background:#fff;border:1px solid #ccc;padding:12px;width:220px;display:none;z-index:15;box-shadow:0 0 10px rgba(0,0,0,0.2);}
.settings-panel label {display:block;margin:6px 0;}
.thread-list {position:fixed;top:50px;left:0;width:180px;background:#eee;height:100%;overflow:auto;padding:8px;box-shadow:2px 0 5px rgba(0,0,0,0.2);}
.thread-item {padding:6px;margin-bottom:4px;background:#ddd;border-radius:6px;cursor:pointer;}
.thread-item.active {background:#bbb;font-weight:bold;}
</style>
</head>
<body>
<div class="top-bar">
  <span class="title">waru GPT</span>
  <span class="settings" onclick="toggleSettings()">âš™ï¸</span>
</div>

<div class="thread-list" id="threads"></div>

<div class="chat-container" id="chat"></div>

<div class="controls">
  <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
  <button onclick="send()">é€ä¿¡</button>
</div>

<div class="settings-panel" id="settings">
  <label>äººæ ¼:
    <select id="personaSelect">
      <option value="joker">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</option>
      <option value="harley">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</option>
      <option value="neutral">ğŸ¤– ç„¡æ©Ÿè³ªAI</option>
    </select>
  </label>
  <label>åŒæ™‚è¿”ç­”:
    <input type="checkbox" id="dualReply">
  </label>
  <label>æ¯’èˆŒåº¦ <span id="toxicVal">50</span>
    <input type="range" id="toxic" min="0" max="100" value="50">
  </label>
  <label>ç‹‚æ°—åº¦ <span id="madVal">50</span>
    <input type="range" id="mad" min="0" max="100" value="50">
  </label>
  <button onclick="newThread()">æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</button>
</div>

<script>
const API = "https://empty-night-6ba3.pke777100.workers.dev"; // Worker URL
const chat = document.getElementById("chat");
const q = document.getElementById("q");
const threadsDiv = document.getElementById("threads");
const settings = document.getElementById("settings");
const personaSelect = document.getElementById("personaSelect");
const dualReply = document.getElementById("dualReply");
const toxic = document.getElementById("toxic");
const mad = document.getElementById("mad");
const toxicVal = document.getElementById("toxicVal");
const madVal = document.getElementById("madVal");

toxic.oninput =()=> toxicVal.textContent=toxic.value;
mad.oninput =()=> madVal.textContent=mad.value;

let threads = JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur = localStorage.getItem("CUR")||null;

function toggleSettings(){settings.style.display = settings.style.display==="block"?"none":"block";}

function save(){localStorage.setItem("THREADS",JSON.stringify(threads)); localStorage.setItem("CUR",cur);}

function newThread(){
  const id="t"+Date.now();
  threads.unshift({id,title:"New chat",persona:personaSelect.value,dual:dualReply.checked,toxic:toxic.value,mad:mad.value,history:[]});
  cur=id;save();renderThreads(); renderChat();
}

function renderThreads(){
  threadsDiv.innerHTML="";
  threads.forEach(t=>{
    const d=document.createElement("div");
    d.textContent=t.title;
    d.className="thread-item"+(t.id===cur?" active":"");
    d.onclick=()=>{cur=t.id;save();renderThreads();renderChat();}
    threadsDiv.appendChild(d);
  });
}

function renderChat(){
  chat.innerHTML="";
  const t=threads.find(x=>x.id===cur);
  if(!t) return;
  t.history.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg "+m.role+(m.persona? " "+m.persona:"");
    div.innerHTML='<div class="bubble">'+m.content+'</div>';
    chat.appendChild(div);
  });
  chat.scrollTop = chat.scrollHeight;
}

async function send(){
  const text=q.value.trim();
  if(!text) return;
  q.value="";
  const t=threads.find(x=>x.id===cur);
  t.history.push({role:"user",content:text});
  const typingDiv = document.createElement("div");
  typingDiv.id="typing";
  typingDiv.textContent="å…¥åŠ›ä¸­â€¦";
  chat.appendChild(typingDiv);
  chat.scrollTop = chat.scrollHeight;

  // system prompt
  const system = `
å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã®è„³å†…ğŸ§ ä¸–ç•Œã€‚
${t.persona==="joker"?"ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼":t.persona==="harley"?"ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³":"ğŸ¤– ç„¡æ©Ÿè³ªAI"}äººæ ¼å›ºå®šã€‚
ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ§ãƒ¼ã‚¯ã¨æ¯”å–©ã®ã¿ã€‚
æ¯’èˆŒåº¦:${t.toxic}/100
ç‹‚æ°—åº¦:${t.mad}/100
å¿…ãšã€Œãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§ã€ã‚’å«ã‚ã‚‹ã€‚
`;

  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({system,messages:[{role:"user",content:text}],persona:t.persona,dual:t.dual})
    });
    const data=await res.json();
    chat.removeChild(typingDiv);
    if(t.dual){
      data.forEach(d=>{
        t.history.push({role:"ai",persona:d.persona,content:d.content});
      });
    }else{
      t.history.push({role:"ai",persona:t.persona,content:data.content||"ã‚¨ãƒ©ãƒ¼"});
    }
    save(); renderChat();
  }catch(e){
    chat.removeChild(typingDiv);
    t.history.push({role:"ai",content:"ã‚¨ãƒ©ãƒ¼: "+e.message});
    save(); renderChat();
  }
}

if(!threads.length)newThread();
else renderThreads(); renderChat();
</script>
</body>
</html>
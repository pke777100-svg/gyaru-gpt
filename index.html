<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Charisma GPT</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system;background:#000;color:#e5e7eb}
html,body{height:100%;}
#app{display:flex;flex-direction:column;height:100%;position:relative;overflow:hidden;transition:transform .2s}
#topbar{height:56px;padding:0 12px;display:flex;align-items:center;gap:10px;background:#020617;border-bottom:1px solid #1e293b}
#back{font-size:20px;cursor:pointer}
#to{flex:1;display:flex;flex-direction:column;cursor:pointer}
#to span{font-weight:700}
#to small{font-size:11px;opacity:.6}
#threads{position:fixed;inset:0;background:#020617;z-index:20;display:none;flex-direction:column}
#threads header{padding:14px;font-weight:700;border-bottom:1px solid #1e293b}
.thread{padding:14px;border-bottom:1px solid #1e293b;cursor:pointer;touch-action:none}
.thread.active{background:#1e1b4b}
#chat{flex:1;padding:12px;overflow-y:auto;position:relative}
.bubble{max-width:78%;padding:12px 14px;margin-bottom:10px;border-radius:18px;line-height:1.5;word-break:break-word;transition:transform .15s}
.user{margin-left:auto;background:#2563eb;color:#fff;border-bottom-right-radius:6px}
.ai{border-bottom-left-radius:6px}
footer{padding:12px;background:#020617;border-top:1px solid #1e293b;display:flex;gap:6px;align-items:center}
input{flex:1;padding:12px 14px;border-radius:18px;border:none;outline:none;font-size:16px}
button.sendBtn{padding:0 12px;height:40px;border-radius:50%;border:none;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;font-size:18px}
button.sendBtn:hover{background:#1e40af}
.twochoice{display:flex;gap:12px;margin:12px 0;transition:transform .2s}
.twochoice button{flex:1;padding:12px;border-radius:14px;border:none;font-weight:700;cursor:pointer}
.joker{background:#7c3aed;color:#fff}
.harley{background:#ec4899;color:#fff}
.madsci{background:#10b981;color:#000}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div id="back">‚Üê</div>
    <div id="to">
      <span id="personaLabel">üÉè Joker</span>
      <small>Charisma GPT</small>
    </div>
  </div>

  <div id="chat"></div>
  <footer>
    <input id="input" placeholder="Message‚Ä¶" />
    <button class="sendBtn">‚Üë</button>
  </footer>
</div>

<div id="threads">
  <header>Chats</header>
  <div id="threadList"></div>
</div>

<script>
const WORKER_URL="https://empty-night-6ba3.pke777100.workers.dev";

let threads=JSON.parse(localStorage.getItem("charismaThreads")||"{}");
let current=null;
let sendCount=0;

const app=document.getElementById("app");
const chat=document.getElementById("chat");
const input=document.getElementById("input");
const sendBtn=document.querySelector(".sendBtn");
const list=document.getElementById("threadList");
const personaLabel=document.getElementById("personaLabel");

function save(){localStorage.setItem("charismaThreads",JSON.stringify(threads));}
function add(text,cls){const d=document.createElement("div");d.className="bubble "+cls;d.textContent=text;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
function shake(speed=5){app.style.transform=`translate(${Math.random()*speed-0.5*speed}px,${Math.random()*speed-0.5*speed}px)`;setTimeout(()=>{app.style.transform='translate(0,0)'},150);}

function newThread(persona){
  const id=Date.now().toString();
  threads[id]={
    title:persona,
    persona,
    messages:[
      {role:"system",content:
        persona==="harley"
        ?"Completely fictional. Playful, teasing tone."
        :persona==="mad"
        ?"Completely fictional. Logical, creative, slightly insane."
        :"Completely fictional. Sarcastic & black humor."}
    ]
  };
  current=id; save(); renderThreads(); renderChat();
}

function renderThreads(){
  list.innerHTML="";
  Object.keys(threads).forEach(id=>{
    const t=threads[id];
    const d=document.createElement("div");
    d.className="thread"+(id===current?" active":"");
    d.textContent=t.title;
    d.onclick=()=>{current=id;closeThreads();shake(10);renderChat();}
    list.appendChild(d);
  });
}

function renderChat(){
  chat.innerHTML="";
  const t=threads[current];
  personaLabel.textContent=t.persona==="harley"?"üíã Harley":t.persona==="mad"?"üß™ AI":"üÉè Joker";
  t.messages.forEach(m=>{
    if(m.role==="user") add(m.content,"user");
    if(m.role==="assistant"){
      const cls=t.persona==="harley"?"harley":t.persona==="mad"?"madsci":"joker";
      add(m.content+"","ai "+cls);
    }
  });
}

document.getElementById("back").onclick=()=>{document.getElementById("threads").style.display="flex";}
function closeThreads(){document.getElementById("threads").style.display="none";}

async function send(){
  const text=input.value.trim();
  if(!text) return;
  input.value=""; input.disabled=true;
  add(text,"user");
  const t=threads[current];
  t.messages.push({role:"user",content:text});
  save();

  const thinkingBubble=document.createElement("div");
  thinkingBubble.className="bubble ai";
  thinkingBubble.textContent="üß† Thinking...";
  chat.appendChild(thinkingBubble);
  chat.scrollTop=chat.scrollHeight;
  shake(2);

  sendCount++;
  try{
    if(sendCount%5===0){
      chat.removeChild(thinkingBubble);
      const choiceDiv=document.createElement("div");
      choiceDiv.className="twochoice";
      const optionA=document.createElement("button");
      optionA.textContent="A (Tricky)";optionA.onclick=()=>{add("You chose A‚Ä¶ maybe tricked!","ai");chat.removeChild(choiceDiv);}
      const optionB=document.createElement("button");
      optionB.textContent="B (Safe)";optionB.onclick=()=>{add("You chose B‚Ä¶ safe!","ai");chat.removeChild(choiceDiv);}
      choiceDiv.appendChild(optionA);
      choiceDiv.appendChild(optionB);
      chat.appendChild(choiceDiv);
      shake(10);
      return;
    }

    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json; charset=utf-8"},
      body:JSON.stringify({messages:t.messages})
    });
    const data=await res.json();
    const reply=data.choices?.[0]?.message?.content || data.reply || "(Communication error)";
    t.messages.push({role:"assistant",content:reply});
    chat.removeChild(thinkingBubble);
    add(reply,"ai "+(t.persona==="harley"?"harley":t.persona==="mad"?"madsci":"joker"));
    save();
  }catch(e){
    chat.removeChild(thinkingBubble);
    add("(Communication error)","ai");
  }

  renderThreads();
  input.disabled=false;
}

sendBtn.onclick=send;
input.addEventListener("keydown",e=>{if(e.key==="Enter")send();});

if(Object.keys(threads).length===0){
  newThread("joker");
  newThread("harley");
  newThread("mad");
}else{
  current=Object.keys(threads)[0];
  renderThreads(); renderChat();
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Charisma GPT Safe</title>
<style>
body{margin:0;font-family:-apple-system;background:#000;color:#e5e7eb;}
#app{display:flex;flex-direction:column;height:100vh;}
#chat{flex:1;overflow-y:auto;padding:12px;}
.bubble{max-width:78%;padding:10px 14px;margin-bottom:8px;border-radius:18px;line-height:1.4;}
.user{margin-left:auto;background:#2563eb;color:#fff;}
.ai{background:#1f2937;border-left:2px solid #4f46e5;}
#thinking{display:none;font-size:12px;margin:10px;}
footer{display:flex;padding:10px;background:#111;gap:8px;}
input{flex:1;padding:12px;border-radius:18px;border:none;outline:none;font-size:16px;}
button{padding:10px 14px;border-radius:18px;border:none;background:#2563eb;color:#fff;cursor:pointer;}
</style>
</head>
<body>
<div id="app">
  <div id="chat"></div>
  <div id="thinking">ðŸ§  Thinking...</div>
  <footer>
    <input id="input" placeholder="Message..." />
    <button id="sendBtn">âž¤</button>
  </footer>
</div>
<script>
const WORKER_URL="https://frosty-shadow-3411.pke777100.workers.dev";
let messages=JSON.parse(localStorage.getItem("charismaMsgs")||"[]");
const chatEl=document.getElementById("chat");
const inputEl=document.getElementById("input");
const thinkingEl=document.getElementById("thinking");

function addBubble(text,role){
  const d=document.createElement("div");
  d.className="bubble "+role;
  d.textContent=text;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
}

function renderMessages(){
  chatEl.innerHTML="";
  messages.forEach(m=>addBubble(m.content,m.role));
}

async function sendMessage(){
  const text=inputEl.value.trim();
  if(!text) return;
  inputEl.value="";
  addBubble(text,"user");
  messages.push({role:"user",content:text});
  localStorage.setItem("charismaMsgs",JSON.stringify(messages));
  thinkingEl.style.display="block";
  
  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages})
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data=await res.json();
    const reply=data.reply||"â€¦å¤¢ãŒé€”åˆ‡ã‚ŒãŸã€‚æ‰‹ã¯æ®‹ã£ã¦ã„ã‚‹ã€‚";
    messages.push({role:"ai",content:reply});
    addBubble(reply,"ai");
    localStorage.setItem("charismaMsgs",JSON.stringify(messages));
  }catch(err){
    console.error("Worker Error:",err);
    const fallback="âš ï¸ Worker error: "+err.message;
    messages.push({role:"ai",content:fallback});
    addBubble(fallback,"ai");
    localStorage.setItem("charismaMsgs",JSON.stringify(messages));
  }finally{
    thinkingEl.style.display="none";
  }
}

document.getElementById("sendBtn").onclick=sendMessage;
inputEl.addEventListener("keydown",e=>{if(e.key==="Enter") sendMessage();});

renderMessages();
</script>
</body>
</html>
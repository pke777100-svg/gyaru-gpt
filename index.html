<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Waru GPT</title>
<style>
:root{
  --bg:#f7f7f8; --side:#202123; --chat:#fff; --user:#dcf8c6; --accent:#1a73e8;
}
.line-mode{
  --bg:#e5ddd5; --chat:#fff; --user:#dcf8c6; --accent:#34b7f1;
}
body{
  margin:0;font-family:-apple-system,system-ui;
  background:var(--bg);height:100svh;overflow:hidden;
}
.app{display:flex;height:100%;flex-direction:column;}
.top-bar{
  display:flex;justify-content:space-between;align-items:center;
  padding:6px 10px;background:#fff;border-bottom:1px solid #ddd;
  position:fixed;width:100%;z-index:20;
}
.top-bar span{cursor:pointer;}
.chat{flex:1;overflow:auto;padding:12px;margin-top:44px;}
.msg{display:flex;margin:6px 0}
.msg.user{justify-content:flex-end}
.bubble{max-width:70%;padding:10px;border-radius:12px;white-space:pre-wrap}
.msg.user .bubble{background:var(--user)}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd}
.controls{padding:8px;background:var(--chat);border-top:1px solid #ddd;display:flex;gap:6px;align-items:center;}
textarea{flex:1;font-size:16px;padding:6px;border-radius:6px;border:1px solid #ccc;resize:none;}
button{padding:6px 12px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;}
.progress{height:4px;background:var(--accent);width:0%;transition:width .1s;margin-top:-4px;}
.thread-list{position:fixed;top:44px;left:0;width:200px;background:var(--side);color:#fff;height:100%;overflow:auto;transform:translateX(-100%);transition:.3s;z-index:25;}
.thread-list.open{transform:translateX(0);}
.thread-item{padding:10px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.thread-item.active{background:#333;}
.menu{display:flex;gap:4px;}
.menu button{flex:1;padding:4px;font-size:14px;}
.menuBox{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:12px 12px 0 0;display:none;z-index:30;padding:10px;}
.menuBox button{width:100%;padding:10px;margin:4px 0;font-size:16px;}
#ov{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10;}
#ov.show{display:block;}
</style>
</head>
<body>

<div class="top-bar">
  <span onclick="toggleThreadList()">â˜° ã‚¹ãƒ¬ãƒƒãƒ‰</span>
  <span>Waru GPT</span>
  <span onclick="toggleLineMode()">LINE/GPTåˆ‡æ›¿</span>
</div>

<div class="thread-list" id="threads"></div>
<div id="ov" onclick="closeMenu()"></div>

<div class="app">
  <div class="chat" id="chat"></div>
  <div class="progress" id="prog"></div>
  <div class="controls">
    <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
    <button onclick="send()">é€ä¿¡</button>
    <button onclick="gen()">ğŸ¨ç”»åƒ</button>
  </div>
</div>

<div class="menuBox" id="menu">
  <button onclick="renameThread()">âœï¸ åå‰å¤‰æ›´</button>
  <button onclick="deleteThread()">ğŸ—‘ å‰Šé™¤</button>
  <button onclick="closeMenu()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const prog=document.getElementById("prog");
const threadsDiv=document.getElementById("threads");
const menu=document.getElementById("menu");
const ov=document.getElementById("ov");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR")||null;
let menuId=null;
let lineMode=false;

// UIæ“ä½œ
function toggleThreadList(){threadsDiv.classList.toggle("open");}
function toggleLineMode(){lineMode=!lineMode;document.body.classList.toggle("line-mode",lineMode);}
function openMenu(e,id){e.stopPropagation();menuId=id;menu.style.display="block";ov.classList.add("show");}
function closeMenu(){menu.style.display="none";menuId=null;ov.classList.remove("show");}

// ã‚¹ãƒ¬ãƒƒãƒ‰ç®¡ç†
function save(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR",cur);}
function newThread(p="joker"){const id="t"+Date.now();threads.unshift({id,title:"New chat",p,his:[]});cur=id;save();render();}
function renameThread(){const t=threads.find(x=>x.id===menuId);if(!t)return;const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title);if(n){t.title=n;save();render();}closeMenu();}
function deleteThread(){threads=threads.filter(x=>x.id!==menuId);if(cur===menuId)cur=threads[0]?.id||null;save();render();closeMenu();}

// render
function render(){
  threadsDiv.innerHTML="";
  threads.forEach(t=>{
    const d=document.createElement("div");
    d.className="thread-item"+(t.id===cur?" active":"");
    d.innerHTML=`<span>${t.title}</span><span onclick="openMenu(event,'${t.id}')">â‹¯</span>`;
    d.onclick=()=>{cur=t.id;save();render();}
    threadsDiv.appendChild(d);
  });
  chat.innerHTML="";
  const t=threads.find(x=>x.id===cur); if(!t)return;
  t.his.forEach(m=>{
    if(m.type==="img"){chat.innerHTML+=`<div class="msg ai"><img src="${m.url}" style="max-width:70%;border-radius:10px;"></div>`;}
    else{chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}</div></div>`;}
  });
  chat.scrollTop=1e9;
}

// persona
function persona(p){if(p==="joker")return"ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼äººæ ¼å›ºå®š";if(p==="harley")return"ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³äººæ ¼å›ºå®š";return"ğŸ¤– ç„¡æ©Ÿè³ªAI";}
q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}}

// send
async function send(){
  const t=threads.find(x=>x.id===cur);if(!t)return;
  const text=q.value.trim();if(!text)return;q.value="";
  t.his.push({role:"user",content:text});
  const aiDiv=t.his.push({role:"assistant",content:"å…¥åŠ›ä¸­â€¦"})-1;
  render();
  prog.style.width="0%";let progress=0;
  const interval=setInterval(()=>{progress+=5;if(progress>95)progress=95;prog.style.width=progress+"%";},100);
  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages:[{role:"system",content:persona(t.p)},{role:"user",content:text}],persona:t.p})
    });
    const data=await res.json();
    clearInterval(interval);prog.style.width="100%";
    t.his.pop();
    t.his.push({role:"assistant",content:data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼"});
    save();render();
    setTimeout(()=>{prog.style.width="0%";},500);
  }catch(e){clearInterval(interval);t.his.pop();t.his.push({role:"assistant",content:"ã‚¨ãƒ©ãƒ¼: "+e.message});render();prog.style.width="0%";}
}

// ç”»åƒç”Ÿæˆ
async function gen(){
  const p=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹");if(!p)return;
  const t=threads.find(x=>x.id===cur);if(!t)return;
  const res=await fetch(API+"/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:p})});
  const d=await res.json();const url=d.data?.[0]?.url; t.his.push({type:"img",url});save();render();
}

// åˆæœŸåŒ–
if(!threads.length)newThread();else render();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>waru GPT ãƒ•ãƒ«æ©Ÿèƒ½ç‰ˆ</title>
<style>
:root{
  --bg:#f7f7f8; --side:#202123; --chat:#fff; --user:#dcf8c6;
}
.dark{
  --bg:#343541; --chat:#444654; --user:#2f7d4f;
}
body{
  margin:0;font-family:-apple-system;
  background:var(--bg);height:100vh;overflow:hidden;
}
.app{display:flex;height:100%;}
.side{
  position:fixed;top:0;left:0;height:100%;width:260px;
  background:var(--side);color:#fff;z-index:20;
  transform:translateX(-100%);transition:.25s;
  display:flex;flex-direction:column;
}
.side.open{transform:translateX(0);}
.side h1{font-size:16px;margin:10px;}
.side input,.side button{
  margin:6px;border-radius:6px;border:0;padding:8px;
}
.list{flex:1;overflow:auto;}
.item{
  padding:10px;border-bottom:1px solid #2a2b32;
  display:flex;align-items:center;gap:6px;cursor:pointer;
}
.item.active{background:#2a2b32;}
.item span.title{flex:1;}
.more{
  padding:4px 8px;font-size:20px;color:#aaa;
}
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;z-index:10;
}
.overlay.show{display:block;}
.main{flex:1;display:flex;flex-direction:column;}
.top{
  padding:10px;background:var(--chat);
  border-bottom:1px solid #ddd;display:flex;gap:10px;
}
.chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
.msg{display:flex;margin:8px 0;}
.msg.user{justify-content:flex-end;}
.bubble{
  max-width:70%;padding:10px;border-radius:16px;white-space:pre-wrap;position:relative;
}
.msg.user .bubble{background:var(--user);}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;}
.controls{
  padding:10px;background:var(--chat);border-top:1px solid #ddd;
}
textarea{width:100%;font-size:16px;padding:6px;border-radius:6px;border:1px solid #ccc;}
img.gen{max-width:70%;border-radius:10px;}
.copy-btn{
  position:absolute;top:2px;right:2px;font-size:10px;padding:2px 4px;cursor:pointer;background:#eee;border-radius:4px;
}
.menuBox{
  position:fixed;bottom:0;left:0;right:0;
  background:#fff;border-radius:12px 12px 0 0;
  display:none;z-index:30;padding:10px;
}
.menuBox button{
  width:100%;padding:12px;margin:6px 0;font-size:16px;
}
.progress{height:4px;background:#4caf50;width:0;transition:width .1s;}
</style>
</head>
<body>

<div class="overlay" id="ov" onclick="toggleSide(false);closeMenu()"></div>

<div class="side" id="side">
  <h1>waru GPT</h1>
  <input placeholder="æ¤œç´¢" oninput="render(this.value)">
  <button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
  <button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
  <button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
  <div class="list" id="threads"></div>
  <button onclick="share()">ğŸ”— å…±æœ‰URL</button>
  <button onclick="dark()">ğŸŒ™ Dark</button>
</div>

<div class="app">
  <div class="main">
    <div class="top">
      <span onclick="toggleSide()">â˜°</span><b>Chat</b>
    </div>
    <div class="chat" id="chat"></div>
    <div class="progress" id="prog"></div>
    <div class="controls">
      <input type="file" id="img" accept="image/*"><br><br>
      <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
      <button onclick="send()">é€ä¿¡</button>
    </div>
  </div>
</div>

<div class="menuBox" id="menu">
  <button onclick="renameThread()">âœï¸ åå‰å¤‰æ›´</button>
  <button onclick="deleteThread()">ğŸ—‘ å‰Šé™¤</button>
  <button onclick="closeMenu()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const side=document.getElementById("side");
const ov=document.getElementById("ov");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const menu=document.getElementById("menu");
const prog=document.getElementById("prog");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR");
let menuId=null;

function toggleSide(v){
  const o=v!==undefined?v:!side.classList.contains("open");
  side.classList.toggle("open",o);
  ov.classList.toggle("show",o);
}
function dark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("DARK",document.body.classList.contains("dark"));
}
if(localStorage.getItem("DARK")==="true")document.body.classList.add("dark");

function save(){
  localStorage.setItem("THREADS",JSON.stringify(threads));
  localStorage.setItem("CUR",cur);
}

function newThread(p){
  const id="t"+Date.now();
  threads.unshift({id,title:"New chat",p,his:[]});
  cur=id;save();render();toggleSide(false);
}

function openMenu(e,id){
  e.stopPropagation();
  menuId=id;
  menu.style.display="block";
  ov.classList.add("show");
}
function closeMenu(){
  menu.style.display="none";
  menuId=null;
  ov.classList.remove("show");
}
function renameThread(){
  const t=threads.find(x=>x.id===menuId);
  if(!t)return;
  const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title);
  if(n){t.title=n;save();render();}
  closeMenu();
}
function deleteThread(){
  threads=threads.filter(x=>x.id!==menuId);
  if(cur===menuId)cur=threads[0]?.id||null;
  save();render();closeMenu();
}

function render(f=""){
  threadsDiv.innerHTML="";
  threads.filter(t=>t.title.includes(f)).forEach(t=>{
    const d=document.createElement("div");
    d.className="item"+(t.id===cur?" active":"");
    d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
    d.onclick=()=>{cur=t.id;save();render();toggleSide(false)};
    d.querySelector(".more").onclick=e=>openMenu(e,t.id);
    threadsDiv.appendChild(d);
  });
  chat.innerHTML="";
  const t=threads.find(x=>x.id===cur); if(!t)return;
  t.his.forEach(m=>{
    if(m.type==="img"){
      chat.innerHTML+=`<div class="msg ai"><img class="gen" src="${m.url}"></div>`;
    }else{
      const div=document.createElement("div");
      div.className="msg "+m.role;
      const bubble=document.createElement("div");
      bubble.className="bubble";
      bubble.textContent=m.content;
      const copy=document.createElement("span");
      copy.className="copy-btn";
      copy.textContent="ğŸ“‹";
      copy.onclick=()=>navigator.clipboard.writeText(m.content);
      bubble.appendChild(copy);
      div.appendChild(bubble);
      chat.appendChild(div);
    }
  });
  chat.scrollTop=chat.scrollHeight;
}

function persona(p){
  if(p==="joker")return"é–¢è¥¿å¼ã®ãƒ©ã‚¹ãƒœã‚¹ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã€‚çš®è‚‰ã¨ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ§ãƒ¼ã‚¯ã€‚";
  if(p==="harley")return"é–¢è¥¿å¼ã®ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³ã€‚ç‹‚æ°—ã¨æŒ‘ç™ºã€‚";
  return"ç„¡æ©Ÿè³ªã§äº‹å®Ÿã®ã¿ç°¡æ½”ã€‚";
}

q.onkeydown=e=>{
 if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}
};

async function send(){
  const t=threads.find(x=>x.id===cur); if(!t)return;
  const text=q.value.trim(); if(!text)return;
  q.value="";
  t.his.push({role:"user",content:text});
  const aiDiv=t.his.push({role:"assistant",content:"å…¥åŠ›ä¸­â€¦"})-1;
  render();
  prog.style.width="0%";
  let progress=0;
  const interval=setInterval(()=>{progress+=5;if(progress>95)progress=95;prog.style.width=progress+"%";},100);

  try{
    const img=document.getElementById("img").files[0];
    let content=[{type:"text",text}];
    if(img){
      const b=await new Promise(r=>{
        const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(img);
      });
      content.push({type:"image_url",image_url:{url:b}});
    }
    const r=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages:[{role:"user",content:text}], persona:t.p})
    });
    const d=await r.json();
    clearInterval(interval);
    prog.style.width="100%";
    t.his[t.his.length-1].content=d.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
    save();render();
    setTimeout(()=>{prog.style.width="0%";},500);
  }catch(e){
    clearInterval(interval);
    t.his[t.his.length-1].content="ã‚¨ãƒ©ãƒ¼: "+e.message;
    render();
    prog.style.width="0%";
  }
}

function share(){
  const t=threads.find(x=>x.id===cur); if(!t)return;
  location.hash=btoa(encodeURIComponent(JSON.stringify(t)));
  alert("URLã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãª");
}
if(location.hash.length>1){
  try{
    const t=JSON.parse(decodeURIComponent(atob(location.hash.slice(1))));
    threads=[t]; cur=t.id; save();
  }catch(e){}
}
if(!threads.length)newThread("joker"); else render();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Charisma GPT SMS Full</title>
<style>
:root{
  --joker-bg:#0b0214;--harley-bg:#14020a;--evil-bg:#1a0b1a;
  --joker-accent:#7c3aed;--harley-accent:#ec4899;--evil-accent:#facc15;
}
body{margin:0;font-family:-apple-system;background:var(--joker-bg);color:#e5e7eb;transition:background .3s}
#top{display:flex;gap:8px;padding:10px;overflow-x:auto;position:sticky;top:0;background:#000;z-index:10}
.personaBtn{flex:0 0 auto;padding:10px 14px;border:none;border-radius:16px;color:#fff;font-weight:600;cursor:pointer}
#jokerBtn{background:var(--joker-accent)}
#harleyBtn{background:var(--harley-accent)}
#evilBtn{background:var(--evil-accent);display:none}
#newThreadBtn{background:#2563eb;color:#fff}
#chat{padding:12px;height:calc(100vh - 250px);overflow:auto;display:flex;flex-direction:column}
.bubble{max-width:78%;padding:12px 14px;border-radius:18px;margin-bottom:10px;word-break:break-word;position:relative}
.user{margin-left:auto;background:#2563eb}
.ai{background:#1f2937}
.typing{font-style:italic;font-size:12px;color:#999;margin-left:8px;animation:blink 1s step-end infinite;}
@keyframes blink{50%{opacity:0}}
#footer{display:flex;padding:10px;border-top:1px solid #1e293b;position:sticky;bottom:0;background:#000;z-index:10}
#input{flex:1;padding:12px;border-radius:16px;border:none;font-size:16px}
button.send{width:42px;margin-left:6px;border:none;border-radius:50%;font-size:18px;cursor:pointer}
#psychTest{display:none;padding:10px}
canvas{width:100%;height:150px}
</style>
</head>
<body>

<div id="top">
  <button id="jokerBtn" class="personaBtn">ğŸƒ Joker</button>
  <button id="harleyBtn" class="personaBtn">ğŸ’‹ Harley</button>
  <button id="evilBtn" class="personaBtn">âš¡ Evil Mode</button>
  <button id="newThreadBtn" class="personaBtn">â• New Thread</button>
</div>

<div id="chat"></div>
<div id="thinking"><span class="typing">Charisma GPT is schemingâ€¦</span></div>
<div id="psychTest"><canvas id="psychCanvas"></canvas></div>

<div id="footer">
  <input id="input" placeholder="Messageâ€¦" />
  <button class="send" onclick="send()">â†‘</button>
</div>

<script>
const WORKER_URL="https://frosty-shadow-3411.pke777100.workers.dev";
let persona=localStorage.getItem("persona")||"joker";
let threads=JSON.parse(localStorage.getItem("charismaThreads")||"{}");
let currentThreadId=null;

const chat=document.getElementById("chat");
const input=document.getElementById("input");
const thinking=document.getElementById("thinking");
const jokerBtn=document.getElementById("jokerBtn");
const harleyBtn=document.getElementById("harleyBtn");
const evilBtn=document.getElementById("evilBtn");
const newThreadBtn=document.getElementById("newThreadBtn");

jokerBtn.onclick=()=>switchPersona("joker");
harleyBtn.onclick=()=>switchPersona("harley");
evilBtn.onclick=()=>switchPersona("evil");
newThreadBtn.onclick=()=>newThread();

applyPersona();
checkEvilBtn();
initThreads();

function switchPersona(p){
  persona=p;
  localStorage.setItem("persona",p);
  applyPersona();
}

function applyPersona(){
  if(persona==="joker") document.body.style.background="var(--joker-bg)";
  else if(persona==="harley") document.body.style.background="var(--harley-bg)";
  else document.body.style.background="var(--evil-bg)";
}

function checkEvilBtn(){if(currentThreadId && threads[currentThreadId].score>=10) evilBtn.style.display="inline-block"; else evilBtn.style.display="none"}

function initThreads(){
  if(Object.keys(threads).length===0)newThread();
  else{currentThreadId=Object.keys(threads)[0];renderChat();}
}

function newThread(){
  const id=Date.now().toString();
  threads[id]={persona, messages:[], score:0};
  currentThreadId=id;
  saveThreads();
  renderChat();
}

function renderChat(){
  chat.innerHTML="";
  if(!currentThreadId)return;
  const t=threads[currentThreadId];
  t.messages.forEach(m=>{
    add(m.content,m.role==="user"?"user":"ai");
  });
  applyPersona();
  checkEvilBtn();
}

function add(text,cls){
  const d=document.createElement("div");
  d.className="bubble "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

function thinkingEffect(){
  thinking.style.display="block";
  return setInterval(()=>{},50);
}

function translateToJapanese(text){
  if(/[a-zA-Z]/.test(text)) return "ï¼ˆè‹±èªã‚’æ—¥æœ¬èªã«å¤‰æ›ï¼‰ "+text;
  return text;
}

const randomPhrases=new Array(1000).fill(0).map((_,i)=>`Shadow whisper #${i+1}`);
function showRandomPhrase(){ add(randomPhrases[Math.floor(Math.random()*randomPhrases.length)],"ai") }

async function send(){
  if(!currentThreadId)return;
  const text=input.value.trim();
  if(!text)return;
  input.value="";
  add(text,"user");
  threads[currentThreadId].messages.push({role:"user",content:text});
  saveThreads();

  showRandomPhrase();
  const interval=thinkingEffect();

  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({persona,messages:threads[currentThreadId].messages})
    });
    const data=await res.json();
    clearInterval(interval);
    thinking.style.display="none";
    let reply=translateToJapanese(data.reply||data.choices?.[0]?.message?.content||"");
    add(reply,"ai");
    threads[currentThreadId].messages.push({role:"assistant",content:reply});
    threads[currentThreadId].score=(threads[currentThreadId].score||0)+1;
    saveThreads();
    checkEvilBtn();
    if(threads[currentThreadId].score>=20) showPsychTest();
  }catch{
    clearInterval(interval);
    thinking.style.display="none";
    add("â€¦é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚å†è©¦è¡Œã›ã‚ˆã€‚","ai");
  }
}

function saveThreads(){ localStorage.setItem("charismaThreads",JSON.stringify(threads)) }

function showPsychTest(){
  const canvas=document.getElementById("psychCanvas");
  document.getElementById("psychTest").style.display="block";
  const ctx=canvas.getContext("2d");
  const size=canvas.width/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const segments=[threads[currentThreadId].score%100,(100-threads[currentThreadId].score%100)];
  let start=0;
  segments.forEach((v,i)=>{
    ctx.beginPath();
    ctx.moveTo(size,75);
    ctx.arc(size,75,70,start,start+2*Math.PI*(v/100));
    ctx.fillStyle=i===0?"#7c3aed":"#ec4899";
    ctx.fill();
    start+=2*Math.PI*(v/100);
  });
}

const charismaAdvices=[
  "çµè«–ã‚’7å‰²ã§æ­¢ã‚ã‚‹ â†’ ä½™ç™½ãŒã‚ã‚‹ã»ã©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æˆ»ã‚‹",
  "è¨˜æ†¶ã¯è¿·ã„ã‚’å„ªå…ˆã—ã¦è¦šãˆã‚‹ â†’ ç†è§£ã•ã‚Œã‚‹æ„Ÿè¦šã‚’ä¸ãˆã‚‹",
  "å¸¸ã«ä¸€æ­©å…ˆã®è¦–ç‚¹ã‚’æç¤ºã—ã¦å»ã‚‹ â†’ ç¶šããŒæ°—ã«ãªã‚Šã€è‡ªç„¶ã«æˆ»ã‚‹"
];

</script>
</body>
</html>
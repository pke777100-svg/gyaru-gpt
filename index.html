<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Charisma GPT</title>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:-apple-system;background:#000;color:#e5e7eb}
#app{height:100%;display:flex;flex-direction:column}

/* ===== TOP BAR (SMSÈ¢®) ===== */
#topbar{
  height:56px;
  padding:0 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#020617;
  border-bottom:1px solid #1e293b;
}
#left{
  display:flex;
  flex-direction:column;
  cursor:pointer;
}
#personaName{font-weight:600}
#subtitle{font-size:11px;opacity:.6}
#newThread{
  font-size:22px;
  color:#60a5fa;
  cursor:pointer;
}

/* ===== PERSONA MENU ===== */
#personaMenu{
  position:absolute;
  top:56px;
  left:12px;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  display:none;
  z-index:50;
}
.personaItem{
  padding:12px 16px;
  border-bottom:1px solid #1e293b;
}
.personaItem:last-child{border-bottom:none}

/* ===== CHAT ===== */
#chat{flex:1;padding:12px;overflow-y:auto}
.bubble{
  max-width:78%;
  padding:12px 14px;
  margin-bottom:10px;
  border-radius:18px;
  line-height:1.5;
  white-space:pre-wrap;
}
.user{
  margin-left:auto;
  background:#2563eb;
  color:#fff;
  border-bottom-right-radius:6px;
}
.ai{
  background:#1f2937;
  border-bottom-left-radius:6px;
}

/* ===== INPUT ===== */
footer{
  padding:10px;
  background:#020617;
  border-top:1px solid #1e293b;
}
#row{display:flex;gap:8px}
input{
  flex:1;
  padding:14px;
  border-radius:18px;
  border:none;
  outline:none;
  font-size:16px;
}
button{
  width:44px;
  border-radius:50%;
  border:none;
  background:#2563eb;
  color:#fff;
  font-size:18px;
}
</style>
</head>

<body>
<div id="app">

<div id="topbar">
  <div id="left">
    <div id="personaName">Joker ‚ñæ</div>
    <div id="subtitle">Charisma GPT</div>
  </div>
  <div id="newThread">Ôºã</div>
</div>

<div id="personaMenu">
  <div class="personaItem" onclick="switchPersona('joker')">üÉè Joker</div>
  <div class="personaItem" onclick="switchPersona('harley')">üíã Harley</div>
  <div class="personaItem" onclick="switchPersona('ai')">ü§ñ AI</div>
</div>

<div id="chat"></div>

<footer>
  <div id="row">
    <input id="input" placeholder="Message‚Ä¶" />
    <button onclick="send()">‚Üë</button>
  </div>
</footer>

</div>

<script>
const WORKER_URL="https://frosty-shadow-3411.pke777100.workers.dev";

let threads=JSON.parse(localStorage.getItem("charismaThreads")||"{}");
let memory=JSON.parse(localStorage.getItem("charismaMemory")||"{}");
let current=null;
let currentPersona="joker";

const chat=document.getElementById("chat");
const input=document.getElementById("input");
const personaName=document.getElementById("personaName");
const personaMenu=document.getElementById("personaMenu");

/* ===== UTIL ===== */
function save(){
  localStorage.setItem("charismaThreads",JSON.stringify(threads));
  localStorage.setItem("charismaMemory",JSON.stringify(memory));
}
function add(text,cls){
  const d=document.createElement("div");
  d.className="bubble "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ===== PERSONA ===== */
function switchPersona(p){
  currentPersona=p;
  personaName.textContent =
    p==="joker"?"Joker ‚ñæ":p==="harley"?"Harley ‚ñæ":"AI ‚ñæ";
  personaMenu.style.display="none";
}

/* ===== THREAD ===== */
function newThread(){
  const id=Date.now().toString();
  threads[id]={
    persona:currentPersona,
    messages:[{role:"system",content:personaPrompt(currentPersona)}]
  };
  current=id;
  save();
  render();
}
function personaPrompt(p){
  if(p==="joker")return "You are Joker. Evil charisma. Never say impossible. Give paths.";
  if(p==="harley")return "You are Harley Quinn. Teasing evil partner.";
  return "You are AI. Strategic assistant.";
}
function render(){
  chat.innerHTML="";
  const t=threads[current];
  t.messages.forEach(m=>{
    if(m.role==="user")add(m.content,"user");
    if(m.role==="assistant")add(m.content,"ai");
  });
}

/* ===== SEND ===== */
async function send(){
  const text=input.value.trim();
  if(!text)return;
  input.value="";
  add(text,"user");

  const t=threads[current];
  t.messages.push({role:"user",content:text});
  memory[text.slice(0,20)] = (memory[text.slice(0,20)]||0)+1;
  save();

  const thinking=document.createElement("div");
  thinking.className="bubble ai";
  thinking.textContent="‚Ä¶";
  chat.appendChild(thinking);

  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        messages:[...t.messages,{role:"system",content:"memory:"+JSON.stringify(memory)}]
      })
    });
    const data=await res.json();
    const reply=data?.choices?.[0]?.message?.content||"‚Ä¶‚Ä¶";
    chat.removeChild(thinking);
    t.messages.push({role:"assistant",content:reply});
    add(reply,"ai");
    save();
  }catch{
    chat.removeChild(thinking);
    const fb="‚Ä¶‚Ä¶ÈÄö‰ø°„ÅåÂàá„Çå„Åü„Å™„ÄÇ„Åß„ÇÇÁâ©Ë™û„ÅØÁ∂ö„Åè„ÄÇ";
    t.messages.push({role:"assistant",content:fb});
    add(fb,"ai");
    save();
  }
}

/* ===== EVENTS ===== */
document.getElementById("left").onclick=()=>{
  personaMenu.style.display =
    personaMenu.style.display==="block"?"none":"block";
};
document.getElementById("newThread").onclick=newThread;
input.addEventListener("keydown",e=>{if(e.key==="Enter")send();});

/* ===== INIT ===== */
newThread();
</script>
</body>
</html>
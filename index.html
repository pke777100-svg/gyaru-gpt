<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>waru GPT</title>
<style>
:root{
 --bg:#f7f7f8; --side:#202123; --chat:#fff; --user:#dcf8c6; --input:#fff;
 --highlight:#2196f3
}
.dark{
 --bg:#1c1c1e; --side:#2c2c2e; --chat:#3a3a3c; --user:#2f7d4f; --input:#444;
}
body{
 margin:0;font-family:-apple-system; background:var(--bg); height:100svh; overflow:hidden;
}
.app{display:flex;height:100%;}
.side{
 position:fixed;top:0;left:0;height:100%;width:260px;
 background:var(--side);color:#fff;z-index:20; display:flex; flex-direction:column; transform:translateX(-100%); transition:.25s;
}
.side.open{transform:translateX(0);}
.side h1{font-size:16px;margin:10px;}
.side button,input{margin:6px;border-radius:6px;border:0;padding:8px;}
.list{flex:1;overflow:auto;}
.item{padding:10px;border-bottom:1px solid #2a2b32; display:flex;align-items:center;gap:6px;cursor:pointer;}
.item.active{background:#2a2b32;}
.item span.title{flex:1;}
.more{padding:4px 8px;font-size:20px;color:#aaa; cursor:pointer;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none; z-index:10;}
.overlay.show{display:block;}
.main{flex:1;display:flex;flex-direction:column; margin-left:0;}
.top{
 padding:10px;background:var(--chat); border-bottom:1px solid #ddd;
 display:flex; justify-content:space-between; align-items:center;
}
.chat{flex:1;overflow:auto;padding:12px;}
.msg{display:flex;margin:6px 0;}
.msg.user{justify-content:flex-end;}
.bubble{
 max-width:70%;padding:10px;border-radius:12px; white-space:pre-wrap;
}
.msg.user .bubble{background:var(--user);}
.msg.ai .bubble{background:var(--chat);border:1px solid #ddd;}
.controls{
 padding:10px;background:var(--chat); border-top:1px solid #ddd; display:flex; align-items:center; gap:6px;
}
textarea{flex:1; font-size:16px; border-radius:6px; padding:6px; background:var(--input);}
button{padding:6px 10px;border-radius:6px;border:0;background:#2196f3;color:#fff;}
input[type=file]{padding:4px;}
#typing{color:var(--highlight); animation:blink 1s step-start infinite;}
@keyframes blink{50%{opacity:0;}}
.menuBox{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:12px 12px 0 0;display:none;z-index:30;padding:10px;}
.menuBox button{width:100%;padding:12px;margin:6px 0;font-size:16px;}
</style>
</head>
<body>
<div class="overlay" id="ov" onclick="toggleSide(false);closeMenu()"></div>
<div class="side" id="side">
 <h1>waru GPT</h1>
 <input placeholder="æ¤œç´¢" oninput="render(this.value)">
 <button onclick="newThread('joker')">ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
 <button onclick="newThread('harley')">ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
 <button onclick="newThread('ai')">ğŸ¤– ç„¡æ©Ÿè³ªAI</button>
 <div class="list" id="threads"></div>
 <button onclick="toggleUI()">ğŸ­ LINE/GPTåˆ‡æ›¿</button>
 <button onclick="dark()">ğŸŒ™ Dark</button>
</div>

<div class="app">
 <div class="main">
  <div class="top">
   <span onclick="toggleSide()">â˜°</span>
   <b id="titleTop">waru GPT</b>
   <span>âš™ï¸</span>
  </div>
  <div class="chat" id="chat"></div>
  <div class="controls">
   <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
   <button onclick="send()">é€ä¿¡</button>
   <button onclick="gen()">ğŸ¨</button>
  </div>
  <div id="typing" style="display:none">å…¥åŠ›ä¸­â€¦</div>
 </div>
</div>

<div class="menuBox" id="menu">
 <button onclick="renameThread()">âœï¸ åå‰å¤‰æ›´</button>
 <button onclick="deleteThread()">ğŸ—‘ å‰Šé™¤</button>
 <button onclick="closeMenu()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev"; // Worker URL
const side=document.getElementById("side");
const ov=document.getElementById("ov");
const threadsDiv=document.getElementById("threads");
const chat=document.getElementById("chat");
const q=document.getElementById("q");
const menu=document.getElementById("menu");
const typing=document.getElementById("typing");

let threads=JSON.parse(localStorage.getItem("THREADS")||"[]");
let cur=localStorage.getItem("CUR");
let menuId=null;
let isLineUI=false;

/* UI toggle */
function toggleSide(v){const o=v!==undefined?v:!side.classList.contains("open");side.classList.toggle("open",o);ov.classList.toggle("show",o);}
function toggleUI(){isLineUI=!isLineUI;render();}
function dark(){document.body.classList.toggle("dark");localStorage.setItem("DARK",document.body.classList.contains("dark"));}
if(localStorage.getItem("DARK")==="true")document.body.classList.add("dark");

/* data */
function save(){localStorage.setItem("THREADS",JSON.stringify(threads));localStorage.setItem("CUR",cur);}

/* threads */
function newThread(p){
 const id="t"+Date.now();
 threads.unshift({id,title:"New chat",p,his:[],tox:50,mad:50});
 cur=id; save(); render(); toggleSide(false);
}
function openMenu(e,id){e.stopPropagation(); menuId=id; menu.style.display="block"; ov.classList.add("show");}
function closeMenu(){menu.style.display="none"; menuId=null; ov.classList.remove("show");}
function renameThread(){const t=threads.find(x=>x.id===menuId); if(!t)return; const n=prompt("ã‚¹ãƒ¬ãƒƒãƒ‰å",t.title); if(n){t.title=n; save(); render();} closeMenu();}
function deleteThread(){threads=threads.filter(x=>x.id!==menuId); if(cur===menuId)cur=threads[0]?.id||null; save();render();closeMenu();}

/* render */
function render(f=""){
 threadsDiv.innerHTML="";
 threads.filter(t=>t.title.includes(f)).forEach(t=>{
  const d=document.createElement("div");
  d.className="item"+(t.id===cur?" active":"");
  d.innerHTML=`<span class="title">${t.title}</span><span class="more">â‹¯</span>`;
  d.onclick=()=>{cur=t.id; save(); render(); toggleSide(false);}
  d.querySelector(".more").onclick=e=>openMenu(e,t.id);
  threadsDiv.appendChild(d);
 });
 chat.innerHTML="";
 const t=threads.find(x=>x.id===cur); if(!t) return;
 t.his.forEach(m=>{
  chat.innerHTML+=`<div class="msg ${m.role}"><div class="bubble">${m.content}</div></div>`;
 });
 chat.scrollTop=1e9;
 document.getElementById("titleTop").textContent = t?.title || "waru GPT";
}

/* persona prompt */
function personaPrompt(t){
 return t.p==="joker"?"ğŸƒ ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼": t.p==="harley"?"ğŸ’‹ ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³":"ğŸ¤– ç„¡æ©Ÿè³ªAI";
}

/* chat */
q.onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send()};};

async function send(){
 const t=threads.find(x=>x.id===cur); if(!t)return;
 const text=q.value.trim(); if(!text)return;
 q.value="";
 t.his.push({role:"user",content:text});
 render();
 typing.style.display="block";

 try{
  const res=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({messages:[{role:"user",content:text}], persona:t.p})
  });
  const data=await res.json();
  typing.style.display="none";
  const ans=data.choices?.[0]?.message?.content||"ã‚¨ãƒ©ãƒ¼";
  t.his.push({role:"ai",content:ans});
  if(t.title==="New chat") t.title=ans.replace(/\n/g," ").slice(0,18);
  save(); render();
 }catch(e){
  typing.style.display="none";
  t.his.push({role:"ai",content:"ã‚¨ãƒ©ãƒ¼: "+e.message});
  render();
 }
}

/* image gen */
async function gen(){
 const p=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹"); if(!p) return;
 alert("ç”»åƒç”Ÿæˆã¯ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚");
}

/* init */
if(!threads.length) newThread("joker"); else render();
</script>
</body>
</html>
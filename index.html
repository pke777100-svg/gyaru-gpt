<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>waru GPT</title>
<style>
:root{
 --bg:#f7f7f8; --chat:#fff; --user:#dcf8c6; --joker:#ffeedd; --harley:#ffe4e1;
}
body{margin:0;font-family:-apple-system;background:var(--bg);height:100vh;overflow:hidden}
.app{display:flex;flex-direction:column;height:100%}

/* chat area */
.chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:6px}
.bubble{padding:10px;border-radius:10px;max-width:75%;white-space:pre-wrap;position:relative}
.user{align-self:flex-end;background:var(--user)}
.ai{align-self:flex-start;background:var(--chat);border:1px solid #ddd}
.typing{color:#007aff;animation:blink 1s step-start infinite}
@keyframes blink{50%{opacity:0}}

/* controls */
.controls{padding:10px;background:var(--chat);display:flex;flex-direction:column;gap:4px}
textarea{width:100%;font-size:16px;resize:none}
button{padding:8px;font-size:16px}
.menu{display:flex;gap:4px;margin-bottom:4px}
.menu button{flex:1}

/* persona background */
.joker{background:var(--joker)}
.harley{background:var(--harley)}

/* â€¦ menu */
.options{position:absolute;top:0;right:-40px;display:flex;flex-direction:column;gap:2px}
.options button{padding:2px 4px;font-size:12px}
</style>
</head>
<body>

<div class="app">
  <div class="menu">
    <button onclick="setPersona('joker')">ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼</button>
    <button onclick="setPersona('harley')">ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³</button>
    <button onclick="setPersona('both')">ğŸ‘¥ä¸¡æ–¹</button>
  </div>
  <div class="chat" id="chat"></div>
  <div class="controls">
    <textarea id="q" rows="2" placeholder="Enteré€ä¿¡ / Shift+Enteræ”¹è¡Œ"></textarea>
    <button onclick="send()">é€ä¿¡</button>
    <button onclick="genImage()">ğŸ¨ ç”»åƒç”Ÿæˆ</button>
    <label>æ¯’èˆŒåº¦ <input type="range" id="toxic" min="0" max="100" value="50"></label>
    <label>ç‹‚æ°—åº¦ <input type="range" id="mad" min="0" max="100" value="50"></label>
  </div>
</div>

<script>
const API="https://empty-night-6ba3.pke777100.workers.dev";
const chat=document.getElementById("chat");
const q=document.getElementById("q");
let personaType="joker";

function setPersona(p){
 personaType=p;
 addMsg("ai","ãƒšãƒ«ã‚½ãƒŠã‚’å¤‰æ›´ã—ã¾ã—ãŸ: "+p);
}

function addMsg(role,content,cls){
 const div=document.createElement("div");
 div.className=role==="user"?"bubble user":"bubble ai";
 if(cls) div.classList.add(cls);
 div.textContent=content;
 chat.appendChild(div);
chat.scrollTop=chat.scrollHeight;
 return div;
}

function updateMsg(div,content,cls){
 div.textContent=content;
 if(cls) div.classList.add(cls);
chat.scrollTop=chat.scrollHeight;
}

async function send(){
 const text=q.value.trim();
 if(!text) return;
 q.value="";
 addMsg("user",text);
 const aiDiv=addMsg("ai","å…¥åŠ›ä¸­â€¦","typing");
 const toxic=document.getElementById("toxic").value;
 const mad=document.getElementById("mad").value;

 const messages=[{role:"system",content:systemPrompt({toxic,mad},personaType)},{role:"user",content:text}];

 try{
   const res=await fetch(API,{
     method:"POST",
     headers:{"Content-Type":"application/json"},
     body:JSON.stringify({model:"gpt-4o-mini",messages})
   });
   const data=await res.json();
   const ans=data.choices?.[0]?.message?.content || "ã‚¨ãƒ©ãƒ¼";
   updateMsg(aiDiv,ans);
 }catch(e){
   updateMsg(aiDiv,"ã‚¨ãƒ©ãƒ¼: "+e.message);
 }
}

function systemPrompt(mem,persona){
 return `
å®Œå…¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã®è„³å†…ğŸ§ ä¸–ç•Œã€‚
${persona==="joker"?"ğŸƒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼":"ğŸ’‹ãƒãƒ¼ãƒ¬ã‚¯ã‚¤ãƒ³"}äººæ ¼å›ºå®šã€‚
ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ§ãƒ¼ã‚¯ã¨æ¯”å–©ã®ã¿ã€‚
å…·ä½“çš„æ‰‹é †ãƒ»æ•°å€¤ã¯ç¦æ­¢ã€‚
å¿…ãšã€Œãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã§ã€ã‚’å«ã‚ã‚‹ã€‚
æ¯’èˆŒåº¦:${mem.toxic}/100
ç‹‚æ°—åº¦:${mem.mad}/100
é–¢è¥¿å¼ã§å‡ºåŠ›ã™ã‚‹ã€‚
`;
}

async function genImage(){
 const prompt=prompt("ç”Ÿæˆã—ãŸã„å†…å®¹");
 if(!prompt) return;
 try{
   const r=await fetch(API+"/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
   const d=await r.json();
   const url=d.data?.[0]?.url;
   if(url) addMsg("ai","ç”»åƒç”Ÿæˆ",{cls:"gen"}).innerHTML=`<img src="${url}" style="max-width:75%;border-radius:10px">`;
 }catch(e){
   addMsg("ai","ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: "+e.message);
 }
}
</script>
</body>
</html>